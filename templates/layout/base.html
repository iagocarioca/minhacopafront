<!doctype html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="theme-color" content="#10B981" />
  <title>{% block title %}MINHACOPA{% endblock %}</title>

  <!-- Google Fonts - Poppins -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'primary': {
              DEFAULT: '#10B981',
              50: '#ECFDF5',
              100: '#D1FAE5',
              200: '#A7F3D0',
              300: '#6EE7B7',
              400: '#34D399',
              500: '#10B981',
              600: '#059669',
              700: '#047857',
              800: '#065F46',
              900: '#064E3B',
            },
          },
        }
      }
    }
  </script>

  <script src="https://unpkg.com/htmx.org@1.9.10"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    /* UX minimalista refinado (Apple-like) */
    body {
      font-family: 'Poppins', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      font-feature-settings: "ss01" 1;
      letter-spacing: -0.011em;
      background: #F5F5F7;
      /* Previne zoom no iOS quando input é focado */
      -webkit-text-size-adjust: 100%;
      -webkit-tap-highlight-color: transparent;
    }

    .border {
      border-width: 0 !important;
    }

    .transition-all {
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* Melhorias de performance e fluidez */
    * {
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* GPU acceleration para elementos que se movem */
    aside,
    header,
    main {
      will-change: transform;
      transform: translateZ(0);
      backface-visibility: hidden;
    }

    /* Transições mais suaves e rápidas */
    @media (prefers-reduced-motion: no-preference) {
      * {
        transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
      }

      /* Transições mais rápidas para melhor responsividade */
      button,
      a,
      .rounded-md,
      .rounded-lg {
        transition-duration: 150ms;
      }
    }

    /* Scroll suave */
    html {
      scroll-behavior: smooth;
    }

    /* Previne layout shift */
    img,
    video {
      max-width: 100%;
      height: auto;
    }

    /* Melhorias mobile - tamanhos maiores (sem quebrar layout) */
    @media (max-width: 768px) {
      body {
        font-size: 15px;
      }

      /* Aumenta min-height de botões mantendo padding original */
      button,
      input[type="submit"],
      input[type="button"] {
        min-height: 48px;
        font-size: 16px;
      }

      /* Aumenta min-height e font-size de inputs mantendo padding original */
      input[type="text"],
      input[type="email"],
      input[type="password"],
      input[type="number"],
      input[type="tel"],
      input[type="date"],
      input[type="time"],
      textarea,
      select {
        min-height: 48px;
        font-size: 16px !important;
      }

      /* Texto maior */
      h1,
      .text-lg {
        font-size: 22px;
        line-height: 1.3;
      }

      h2,
      .text-base {
        font-size: 20px;
        line-height: 1.3;
      }

      .text-sm {
        font-size: 15px;
      }

      .text-xs {
        font-size: 13px;
      }

      /* Ícones maiores - especialmente botões de ação do header */
      #btnBack [data-lucide] {
        width: 24px !important;
        height: 24px !important;
      }

      /* Ícones em botões e links maiores (exceto header que já tem tamanho específico) */
      button:not(#btnBack) [data-lucide],
      a [data-lucide] {
        width: 20px !important;
        height: 20px !important;
      }

      /* Ícones gerais um pouco maiores */
      [data-lucide]:not(#btnBack [data-lucide]):not(button [data-lucide]):not(a [data-lucide]) {
        width: 18px !important;
        height: 18px !important;
      }

      /* Header mais alto para acomodar botões maiores */
      header {
        min-height: 64px;
      }

      /* Bottom navigation maior e mais espaçado */
      nav.fixed.bottom-0 {
        padding-bottom: env(safe-area-inset-bottom, 8px);
      }

      nav.fixed.bottom-0>div {
        padding: 10px 8px;
      }

      nav.fixed.bottom-0 a,
      nav.fixed.bottom-0 button {
        min-height: 56px;
        padding: 10px 12px;
        gap: 6px;
      }

      nav.fixed.bottom-0 [data-lucide] {
        width: 24px !important;
        height: 24px !important;
      }

      nav.fixed.bottom-0 span {
        font-size: 12px;
        font-weight: 500;
      }

      /* Labels maiores */
      label {
        font-size: 14px;
      }
    }

    /* Hover apenas border/bg (sem elevação) - tons verdes */
    .hover-border:hover {
      border-color: rgba(16, 185, 129, 0.3);
      background: rgba(255, 255, 255, 0.4);
    }

    /* Scrollbar minimalista */
    ::-webkit-scrollbar {
      width: 4px;
      height: 4px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: rgba(16, 185, 129, 0.3);
      border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: rgba(16, 185, 129, 0.5);
    }

    /* Remove degradê no topo de elementos com scroll - aplicado globalmente */
    * {
      -webkit-mask-image: none !important;
      mask-image: none !important;
    }
    
    /* Exceção para elementos que precisam de mask (se houver algum) */
    img,
    svg {
      -webkit-mask-image: initial;
      mask-image: initial;
    }

    /* Previne zoom automático no iOS quando input é focado */
    /* Todos os inputs devem ter font-size >= 16px */
    input[type="text"],
    input[type="email"],
    input[type="password"],
    input[type="number"],
    input[type="tel"],
    input[type="url"],
    input[type="search"],
    input[type="date"],
    input[type="time"],
    input[type="datetime-local"],
    textarea,
    select {
      font-size: 16px !important;
      /* Remove zoom no iOS Safari */
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      /* Melhora legibilidade no mobile */
      line-height: 1.5;
    }

    /* Ajusta tamanho do placeholder para manter proporção */
    input[type="text"]::placeholder,
    input[type="email"]::placeholder,
    input[type="password"]::placeholder,
    input[type="number"]::placeholder,
    input[type="tel"]::placeholder,
    input[type="url"]::placeholder,
    input[type="search"]::placeholder,
    input[type="date"]::placeholder,
    input[type="time"]::placeholder,
    textarea::placeholder {
      font-size: 16px;
      opacity: 0.6;
    }

    /* Ajusta select para parecer mais nativo no mobile */
    select {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23666' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      background-size: 12px;
      padding-right: 36px;
    }

    /* Remove highlight azul no iOS */
    input,
    textarea,
    select {
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
    }

    /* Melhora experiência de toque */
    button,
    a,
    input,
    select,
    textarea {
      touch-action: manipulation;
    }

    /* Melhorias para experiência mobile/app-like */
    @media (max-width: 768px) {

      /* Previne seleção de texto acidental no mobile */
      * {
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
      }

      input,
      textarea,
      [contenteditable] {
        -webkit-user-select: text;
        -moz-user-select: text;
        -ms-user-select: text;
        user-select: text;
      }

      /* Previne pull-to-refresh no iOS */
      body {
        overscroll-behavior-y: contain;
        -webkit-overflow-scrolling: touch;
      }

      /* Melhora scroll suave */
      * {
        -webkit-overflow-scrolling: touch;
      }

      /* Ajusta safe area para iPhone X e superiores */
      body {
        padding-bottom: env(safe-area-inset-bottom);
        padding-left: env(safe-area-inset-left);
        padding-right: env(safe-area-inset-right);
      }
    }
  </style>
</head>

{% set _pelada_id = pelada_id if pelada_id is defined else (pelada.id if pelada is defined and pelada and pelada.id is
defined else None) %}
{% set _temporada_id = temporada_id if temporada_id is defined else (temporada.id if temporada is defined and temporada
and temporada.id is defined else None) %}
{% set _rodada_id = rodada_id if rodada_id is defined else (rodada.id if rodada is defined and rodada and rodada.id is
defined else None) %}

<body class="min-h-screen text-slate-900 antialiased text-[13px]">
  <!-- Mobile overlay -->
  <div id="overlay" class="fixed inset-0 bg-slate-900/20 backdrop-blur-sm hidden z-40"></div>

  <div class="min-h-screen lg:grid lg:grid-cols-12">
    <!-- Sidebar -->
    <aside id="sidebar" class="fixed lg:static z-50 lg:z-auto inset-y-0 left-0 w-[270px] lg:w-auto
         bg-white/30
         -translate-x-full lg:translate-x-0 transition-transform duration-200 ease-out
         lg:col-span-3 xl:col-span-2" style="will-change: transform;">
      <div class="h-full flex flex-col">
        <!-- Logo -->
        <div class="px-4 py-5">
          <a href="/peladas" class="flex items-center justify-center group">
            <img src="{{ url_for('static', filename='imgs/logo.png') }}" alt="Logo"
              class="w-24 h-24 object-contain flex-shrink-0 max-w-full" />
          </a>
        </div>

        <!-- Nav -->
        <nav class="px-3 py-4 flex-1 overflow-auto">
          <p class="px-3 text-[10px] font-semibold text-slate-400 uppercase tracking-wide mb-2">Menu</p>

          <!-- Peladas -->
          <a class="group relative flex items-center gap-2.5 px-3 py-2.5 rounded-md transition-all hover:bg-white/40
            {% if request.path.startswith('/peladas') and not request.path.endswith('/jogadores') and not request.path.endswith('/temporadas') %}border-l-4 border-emerald-500{% else %}border-l-4 border-transparent{% endif %}"
            href="/peladas">
            <i data-lucide="layout-grid" class="w-4 h-4 text-emerald-600"></i>
            <span
              class="text-[13px] font-medium {% if request.path.startswith('/peladas') and not request.path.endswith('/jogadores') and not request.path.endswith('/temporadas') %}text-emerald-600{% else %}text-slate-700{% endif %}">Peladas</span>
          </a>

          <!-- Jogadores -->
          <a class="group relative mt-1.5 flex items-center gap-2.5 px-3 py-2.5 rounded-md transition-all hover:bg-white/40
              {% if request.path.startswith('/peladas/') and '/jogadores' in request.path %}border-l-4 border-emerald-500{% else %}border-l-4 border-transparent{% endif %}"
            href="{% if _pelada_id %}/peladas/{{_pelada_id}}/jogadores{% else %}/peladas{% endif %}">
            <i data-lucide="users"
              class="w-4 h-4 {% if request.path.startswith('/peladas/') and '/jogadores' in request.path %}text-emerald-600{% else %}text-slate-600{% endif %}"></i>
            <span
              class="text-[13px] font-medium {% if request.path.startswith('/peladas/') and '/jogadores' in request.path %}text-emerald-600{% else %}text-slate-700{% endif %}">Jogadores</span>
          </a>

          <!-- Temporadas -->
          <a class="group relative mt-1.5 flex items-center gap-2.5 px-3 py-2.5 rounded-md transition-all hover:bg-white/40
              {% if request.path.startswith('/peladas/') and '/temporadas' in request.path %}border-l-4 border-emerald-500{% else %}border-l-4 border-transparent{% endif %}"
            href="{% if _pelada_id %}/peladas/{{_pelada_id}}/temporadas{% else %}/peladas{% endif %}">
            <i data-lucide="calendar"
              class="w-4 h-4 {% if request.path.startswith('/peladas/') and '/temporadas' in request.path %}text-emerald-600{% else %}text-slate-600{% endif %}"></i>
            <span
              class="text-[13px] font-medium {% if request.path.startswith('/peladas/') and '/temporadas' in request.path %}text-emerald-600{% else %}text-slate-700{% endif %}">Temporadas</span>
          </a>

          <div class="my-4 mx-3 h-px bg-slate-200/50"></div>
          <p class="px-3 text-[10px] font-semibold text-slate-400 uppercase tracking-wide mb-2">Temporada</p>

          <!-- Times -->
          <a class="group relative flex items-center gap-2.5 px-3 py-2.5 rounded-md transition-all hover:bg-white/40
              {% if request.path.startswith('/temporadas/') and '/times' in request.path %}border-l-4 border-emerald-500{% else %}border-l-4 border-transparent{% endif %}"
            href="{% if _temporada_id %}/temporadas/{{_temporada_id}}/times{% else %}/peladas{% endif %}">
            <i data-lucide="shirt"
              class="w-4 h-4 {% if request.path.startswith('/temporadas/') and '/times' in request.path %}text-emerald-600{% else %}text-slate-600{% endif %}"></i>
            <span
              class="text-[13px] font-medium {% if request.path.startswith('/temporadas/') and '/times' in request.path %}text-emerald-600{% else %}text-slate-700{% endif %}">Times</span>
          </a>

          <!-- Rodadas -->
          <a class="group relative mt-1.5 flex items-center gap-2.5 px-3 py-2.5 rounded-md transition-all hover:bg-white/40
              {% if request.path.startswith('/temporadas/') and '/rodadas' in request.path %}border-l-4 border-emerald-500{% else %}border-l-4 border-transparent{% endif %}"
            href="{% if _temporada_id %}/temporadas/{{_temporada_id}}/rodadas{% else %}/peladas{% endif %}">
            <i data-lucide="trophy"
              class="w-4 h-4 {% if request.path.startswith('/temporadas/') and '/rodadas' in request.path %}text-emerald-600{% else %}text-slate-600{% endif %}"></i>
            <span
              class="text-[13px] font-medium {% if request.path.startswith('/temporadas/') and '/rodadas' in request.path %}text-emerald-600{% else %}text-slate-700{% endif %}">Rodadas</span>
          </a>

          <!-- Rankings -->
          <a class="group relative mt-1.5 flex items-center gap-2.5 px-3 py-2.5 rounded-md transition-all hover:bg-white/40
              {% if request.path.startswith('/temporadas/') and '/ranking' in request.path %}border-l-4 border-emerald-500{% else %}border-l-4 border-transparent{% endif %}"
            href="{% if _temporada_id %}/temporadas/{{_temporada_id}}/ranking{% else %}/peladas{% endif %}">
            <i data-lucide="bar-chart-3"
              class="w-4 h-4 {% if request.path.startswith('/temporadas/') and '/ranking' in request.path %}text-emerald-600{% else %}text-slate-600{% endif %}"></i>
            <span
              class="text-[13px] font-medium {% if request.path.startswith('/temporadas/') and '/ranking' in request.path %}text-emerald-600{% else %}text-slate-700{% endif %}">Rankings</span>
          </a>

          <div class="my-4 mx-3 h-px bg-slate-200/50"></div>
          <p class="px-3 text-[10px] font-semibold text-slate-400 uppercase tracking-wide mb-2">Rodada</p>

          <!-- Partidas -->
          <a class="group relative flex items-center gap-2.5 px-3 py-2.5 rounded-md transition-all hover:bg-white/40
              {% if request.path.startswith('/rodadas/') and not '/votacoes' in request.path %}border-l-4 border-emerald-500{% else %}border-l-4 border-transparent{% endif %}"
            href="{% if _rodada_id %}/rodadas/{{_rodada_id}}{% else %}/peladas{% endif %}">
            <i data-lucide="swords"
              class="w-4 h-4 {% if request.path.startswith('/rodadas/') and not '/votacoes' in request.path %}text-emerald-600{% else %}text-slate-600{% endif %}"></i>
            <span
              class="text-[13px] font-medium {% if request.path.startswith('/rodadas/') and not '/votacoes' in request.path %}text-emerald-600{% else %}text-slate-700{% endif %}">Partidas</span>
          </a>

          <!-- Votações -->
          <a class="group relative mt-1.5 flex items-center gap-2.5 px-3 py-2.5 rounded-md transition-all hover:bg-white/40
              {% if request.path.startswith('/rodadas/') and '/votacoes' in request.path %}border-l-4 border-emerald-500{% else %}border-l-4 border-transparent{% endif %}"
            href="{% if _rodada_id %}/rodadas/{{_rodada_id}}/votacoes{% else %}/peladas{% endif %}">
            <i data-lucide="vote"
              class="w-4 h-4 {% if request.path.startswith('/rodadas/') and '/votacoes' in request.path %}text-emerald-600{% else %}text-slate-600{% endif %}"></i>
            <span
              class="text-[13px] font-medium {% if request.path.startswith('/rodadas/') and '/votacoes' in request.path %}text-emerald-600{% else %}text-slate-700{% endif %}">Votações</span>
          </a>

          <div class="my-4 mx-3 h-px bg-slate-200/50"></div>
          <a class="group relative flex items-center gap-2.5 px-3 py-2.5 rounded-md transition-all hover:bg-white/40 border-l-4 border-transparent"
            href="/logout">
            <i data-lucide="log-out" class="w-4 h-4 text-slate-600"></i>
            <span class="text-[13px] font-medium text-slate-600">Sair</span>
          </a>
        </nav>

        <!-- User -->
        <div class="px-4 py-4 bg-white/20 backdrop-blur-xl">
          <div class="flex items-center gap-2.5">
            <div class="w-9 h-9 rounded-md bg-gradient-to-br from-emerald-500 to-emerald-600 grid place-items-center">
              <span
                class="text-white font-semibold text-xs">{{ (gerente.username[0] if gerente and gerente.username is defined else "U") | upper }}</span>
            </div>
            <div class="flex-1 min-w-0">
              <p class="text-xs font-semibold text-slate-900 truncate">
                {{ gerente.username if gerente and gerente.username is defined else "Usuário" }}
              </p>
              <p class="text-[10px] text-slate-500">Organizador</p>
            </div>
          </div>
        </div>
      </div>
    </aside>

    <!-- Main -->
    <div class="lg:col-span-9 xl:col-span-10">
      <!-- Header (minimalista: sem bordas) -->
      <header class="z-30 bg-white/30 backdrop-blur-3xl">
        <div class="px-4 py-3 relative">
          <!-- Voltar (mobile clean) -->
          <button id="btnBack" onclick="smartBack()"
            class="lg:hidden absolute left-4 top-1/2 -translate-y-1/2 w-12 h-12 rounded-md bg-white/60 backdrop-blur-xl hover:bg-emerald-50/80 hover:border-emerald-200 grid place-items-center transition-all border border-transparent z-10">
            <i data-lucide="arrow-left" class="w-6 h-6 text-slate-700"></i>
          </button>

          <!-- Header Content -->
          <div class="flex items-center justify-center lg:justify-start lg:gap-3">
            <!-- Desktop: Breadcrumb -->
            <div class="hidden lg:flex lg:items-center lg:gap-3">
              <div class="text-xs text-slate-500">
                {% block breadcrumb %}Painel{% endblock %}
              </div>
              <div class="text-xs text-slate-400">/</div>
            </div>
            <!-- Título (desktop e mobile) -->
            <h1 class="text-base font-medium text-slate-900 tracking-tight">{% block page_title %}Painel{% endblock %}</h1>
          </div>

          <!-- Action (se precisar) -->
          <div class="hidden md:block absolute right-4 top-1/2 -translate-y-1/2">
            {% block header_action %}{% endblock %}
          </div>
        </div>
      </header>

      <!-- Content -->
      <main class="p-4 sm:p-6 pb-24 lg:pb-6">

        <!-- Flash Messages -->
        {% with msgs = get_flashed_messages(with_categories=true) %}
        {% if msgs %}
        <div class="space-y-2 mb-5">
          {% for cat, msg in msgs %}
          <div class="rounded-md px-4 py-3 text-xs border backdrop-blur-xl
                  {% if cat == 'ok' %}
                    bg-emerald-50/60 border-emerald-300/60 text-emerald-800
                  {% else %}
                    bg-rose-50/60 border-rose-300/60 text-rose-800
                  {% endif %}">
            {{ msg }}
          </div>
          {% endfor %}
        </div>
        {% endif %}
        {% endwith %}

        <!-- Toast container -->
        <div id="toast" class="fixed top-20 right-4 z-50 hidden">
          <div
            class="rounded-md bg-white/90 backdrop-blur-xl border border-slate-300/70 shadow-lg px-4 py-3 text-sm text-slate-900">
            <span id="toast-msg"></span>
          </div>
        </div>

        <!-- Share preview modal -->
        <div id="shareModal" class="fixed inset-0 z-[99999] hidden">
          <div class="absolute inset-0 bg-black/50 backdrop-blur-sm"></div>
          <div class="absolute inset-0 p-4 flex items-center justify-center">
            <div class="w-full max-w-md rounded-lg bg-white/95 backdrop-blur-2xl border border-slate-300/60 shadow-xl overflow-hidden">
              <div class="px-4 py-3 border-b border-slate-200/60 flex items-center justify-between">
                <div class="text-sm font-semibold text-slate-900">Prévia</div>
                <button type="button" onclick="window.closeShareModal && window.closeShareModal()" class="w-9 h-9 rounded-md bg-white/70 hover:bg-white border border-slate-300/60 grid place-items-center">
                  <i data-lucide="x" class="w-4 h-4 text-slate-700"></i>
                </button>
              </div>
              <div class="p-4 space-y-3">
                <img id="sharePreviewImg" alt="Prévia do compartilhamento" class="w-full rounded-md border border-slate-200/60 bg-white object-contain" />
                <div class="text-[11px] text-slate-600">
                  No celular (Chrome/Android) deve abrir o compartilhamento do WhatsApp. Se não abrir automaticamente, use a prévia para compartilhar manualmente.
                </div>
                <div class="flex gap-2">
                  <button id="shareModalShareBtn" type="button" class="flex-1 h-10 rounded-md bg-emerald-600 hover:bg-emerald-700 text-white text-sm font-semibold transition-all inline-flex items-center justify-center gap-2">
                    <i data-lucide="share-2" class="w-4 h-4"></i>
                    Compartilhar
                  </button>
                  <button id="shareModalDownloadBtn" type="button" class="h-10 px-4 rounded-md bg-white/70 hover:bg-white text-sm font-semibold text-slate-700 transition-all inline-flex items-center justify-center border border-slate-300/60">
                    Baixar
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        {% block content %}{% endblock %}
      </main>
    </div>
  </div>

  <!-- Bottom Navigation (Mobile) -->
  <nav
    class="fixed bottom-0 left-0 right-0 z-50 bg-white/95 backdrop-blur-2xl border-t border-slate-200/60 lg:hidden safe-area-bottom">
    <div class="flex items-center justify-around px-2 py-2">
      <!-- Peladas (sempre visível) -->
      <a href="/peladas"
        class="flex flex-col items-center justify-center gap-1 px-3 py-2 rounded-md transition-all
        {% if request.path == '/peladas' or (request.path.startswith('/peladas') and not '/jogadores' in request.path and not '/temporadas' in request.path and not '/perfil' in request.path) %}text-emerald-600{% else %}text-slate-500 hover:text-slate-700{% endif %}">
        <i data-lucide="layout-grid" class="w-6 h-6"></i>
        <span class="text-[11px] font-medium">Peladas</span>
      </a>

      <!-- Jogadores (se houver pelada) -->
      {% if _pelada_id %}
      <a href="/peladas/{{_pelada_id}}/jogadores"
        class="flex flex-col items-center justify-center gap-1 px-3 py-2 rounded-md transition-all
          {% if '/jogadores' in request.path %}text-emerald-600{% else %}text-slate-500 hover:text-slate-700{% endif %}">
        <i data-lucide="users" class="w-6 h-6"></i>
        <span class="text-[11px] font-medium">Jogadores</span>
      </a>
      {% else %}
      <a href="/peladas"
        class="flex flex-col items-center justify-center gap-1 px-3 py-2 rounded-md transition-all text-slate-400 opacity-50">
        <i data-lucide="users" class="w-6 h-6"></i>
        <span class="text-[11px] font-medium">Jogadores</span>
      </a>
      {% endif %}

      <!-- Partidas (se houver rodada) -->
      {% if _rodada_id %}
      <a href="/rodadas/{{_rodada_id}}"
        class="flex flex-col items-center justify-center gap-1 px-3 py-2 rounded-md transition-all
          {% if request.path.startswith('/rodadas/') and not '/votacoes' in request.path %}text-emerald-600{% else %}text-slate-500 hover:text-slate-700{% endif %}">
        <i data-lucide="swords" class="w-6 h-6"></i>
        <span class="text-[11px] font-medium">Partidas</span>
      </a>
      {% else %}
      <a href="/peladas"
        class="flex flex-col items-center justify-center gap-1 px-3 py-2 rounded-md transition-all text-slate-400 opacity-50">
        <i data-lucide="swords" class="w-6 h-6"></i>
        <span class="text-[11px] font-medium">Partidas</span>
      </a>
      {% endif %}

      <!-- Rankings (se houver temporada) -->
      {% if _temporada_id %}
      <a href="/temporadas/{{_temporada_id}}/ranking" class="flex flex-col items-center justify-center gap-1 px-3 py-2 rounded-md transition-all
          {% if '/ranking' in request.path %}text-emerald-600{% else %}text-slate-500 hover:text-slate-700{% endif %}">
        <i data-lucide="bar-chart-3" class="w-6 h-6"></i>
        <span class="text-[11px] font-medium">Rankings</span>
      </a>
      {% else %}
      <a href="/peladas"
        class="flex flex-col items-center justify-center gap-1 px-3 py-2 rounded-md transition-all text-slate-400 opacity-50">
        <i data-lucide="bar-chart-3" class="w-6 h-6"></i>
        <span class="text-[11px] font-medium">Rankings</span>
      </a>
      {% endif %}

      <!-- Menu (sempre visível) -->
      <button onclick="openSidebar()"
        class="flex flex-col items-center justify-center gap-1 px-3 py-2 rounded-md transition-all text-slate-500 hover:text-slate-700">
        <i data-lucide="menu" class="w-6 h-6"></i>
        <span class="text-[11px] font-medium">Menu</span>
      </button>
    </div>
  </nav>

  <!-- Scripts (HTMX + Lucide + Sidebar + Dropdown) -->
  <script>
    // Armazena a URL inicial da página (antes de qualquer atualização HTMX)
    let initialUrl = window.location.href;
    let lastDifferentUrl = document.referrer || '/peladas';

    // Função para voltar seguindo o fluxo hierárquico da aplicação
    function smartBack() {
      const currentPath = window.location.pathname;
      let targetUrl = '/peladas'; // URL padrão

      // 1. Detalhe de partida → Detalhe da rodada
      if (currentPath.match(/^\/partidas\/\d+$/)) {
        const rodadaIdElement = document.querySelector('[data-rodada-id]');
        if (rodadaIdElement) {
          const rodadaId = rodadaIdElement.getAttribute('data-rodada-id');
          if (rodadaId) {
            targetUrl = `/rodadas/${rodadaId}`;
          }
        }
      }
      // 3. Votações da rodada → Detalhe da rodada
      else if (currentPath.match(/^\/rodadas\/\d+\/votacoes/)) {
        const rodadaId = currentPath.match(/\/rodadas\/(\d+)/)[1];
        targetUrl = `/rodadas/${rodadaId}`;
      }
      // 4. Detalhe da rodada → Lista de rodadas da temporada
      else if (currentPath.match(/^\/rodadas\/\d+$/)) {
        const temporadaIdElement = document.querySelector('[data-temporada-id]');
        if (temporadaIdElement) {
          const temporadaId = temporadaIdElement.getAttribute('data-temporada-id');
          if (temporadaId) {
            targetUrl = `/temporadas/${temporadaId}/rodadas`;
          }
        }
      }
      // 5. Lista de rodadas → Detalhe da temporada
      else if (currentPath.match(/^\/temporadas\/\d+\/rodadas$/)) {
        const temporadaId = currentPath.match(/\/temporadas\/(\d+)/)[1];
        targetUrl = `/temporadas/${temporadaId}`;
      }
      // 6. Lista de times → Detalhe da temporada
      else if (currentPath.match(/^\/temporadas\/\d+\/times$/)) {
        const temporadaId = currentPath.match(/\/temporadas\/(\d+)/)[1];
        targetUrl = `/temporadas/${temporadaId}`;
      }
      // 7. Rankings → Detalhe da temporada
      else if (currentPath.match(/^\/temporadas\/\d+\/ranking/)) {
        const temporadaId = currentPath.match(/\/temporadas\/(\d+)/)[1];
        targetUrl = `/temporadas/${temporadaId}`;
      }
      // 8. Detalhe da temporada → Lista de temporadas da pelada
      else if (currentPath.match(/^\/temporadas\/\d+$/)) {
        const peladaIdElement = document.querySelector('[data-pelada-id]');
        if (peladaIdElement) {
          const peladaId = peladaIdElement.getAttribute('data-pelada-id');
          if (peladaId) {
            targetUrl = `/peladas/${peladaId}/temporadas`;
          }
        }
      }
      // 9. Lista de temporadas → Perfil da pelada
      else if (currentPath.match(/^\/peladas\/\d+\/temporadas$/)) {
        const peladaId = currentPath.match(/\/peladas\/(\d+)/)[1];
        targetUrl = `/peladas/${peladaId}`;
      }
      // 10. Lista de jogadores → Perfil da pelada
      else if (currentPath.match(/^\/peladas\/\d+\/jogadores$/)) {
        const peladaId = currentPath.match(/\/peladas\/(\d+)/)[1];
        targetUrl = `/peladas/${peladaId}`;
      }
      // 11. Editar jogador → Lista de jogadores
      else if (currentPath.match(/^\/jogadores\/\d+\/edit$/)) {
        const peladaIdElement = document.querySelector('[data-pelada-id]');
        if (peladaIdElement) {
          const peladaId = peladaIdElement.getAttribute('data-pelada-id');
          if (peladaId) {
            targetUrl = `/peladas/${peladaId}/jogadores`;
          }
        }
      }
      // 12. Detalhe do time → Lista de times da temporada
      else if (currentPath.match(/^\/times\/\d+$/)) {
        const temporadaIdElement = document.querySelector('[data-temporada-id]');
        if (temporadaIdElement) {
          const temporadaId = temporadaIdElement.getAttribute('data-temporada-id');
          if (temporadaId) {
            targetUrl = `/temporadas/${temporadaId}/times`;
          }
        }
      }
      // 13. Perfil da pelada → Lista de peladas
      else if (currentPath.match(/^\/peladas\/\d+$/)) {
        targetUrl = '/peladas';
      }
      // 14. Se já está na lista de peladas, não faz nada
      else if (currentPath === '/peladas') {
        return;
      }

      if (targetUrl && targetUrl !== currentPath) {
        window.location.href = targetUrl;
      } else {
        // Fallback: tenta usar history.back() se não conseguiu determinar a rota
        history.back();
      }
    }

    // Atualiza a URL inicial quando a página é carregada (não em atualizações HTMX)
    document.addEventListener('DOMContentLoaded', function () {
      initialUrl = window.location.href;
      if (document.referrer) {
        lastDifferentUrl = document.referrer;
      }
    });

    // Reseta a URL inicial quando há uma navegação real (não HTMX)
    window.addEventListener('popstate', function () {
      initialUrl = window.location.href;
    });

    // Lucide icons
    try { window.lucide && window.lucide.createIcons(); } catch (e) { }
    document.body.addEventListener('htmx:load', () => {
      try { window.lucide && window.lucide.createIcons(); } catch (e) { }
    });
    document.body.addEventListener('htmx:afterSwap', () => {
      try { window.lucide && window.lucide.createIcons(); } catch (e) { }
    });

    // Mobile sidebar toggle (otimizado para performance)
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('overlay');
    const btnClose = document.getElementById('btnClose');

    window.openSidebar = function () {
      if (!sidebar || !overlay) return;
      requestAnimationFrame(() => {
        overlay.classList.remove('hidden');
        sidebar.classList.remove('-translate-x-full');
      });
    };

    function closeSidebar() {
      if (!sidebar || !overlay) return;
      requestAnimationFrame(() => {
        sidebar.classList.add('-translate-x-full');
        setTimeout(() => {
          overlay.classList.add('hidden');
        }, 200); // Aguarda animação terminar
      });
    }

    if (overlay) {
      overlay.addEventListener('click', closeSidebar, { passive: true });
    }
    if (btnClose) {
      btnClose.addEventListener('click', closeSidebar, { passive: true });
    }

    // Fecha sidebar ao clicar em links (mobile)
    if (sidebar) {
      sidebar.querySelectorAll('a').forEach(link => {
        link.addEventListener('click', () => {
          if (window.innerWidth < 1024) {
            closeSidebar();
          }
        }, { passive: true });
      });
    }

    // Toast (para erros globais)
    window.showToast = function (msg) {
      const toast = document.getElementById('toast');
      const toastMsg = document.getElementById('toast-msg');
      if (toast && toastMsg) {
        toastMsg.textContent = msg;
        toast.classList.remove('hidden');
        setTimeout(() => toast.classList.add('hidden'), 4000);
      }
    };

    // Share screenshot (Rankings)
    // - Captura um container por id
    // - Esconde elementos com data-share-hide="1" durante a captura
    // - Se suportar Web Share (Android/WhatsApp), compartilha como imagem
    // - Senão, baixa a imagem
    window.shareScreenshot = async function (containerId, filename, titleText) {
      try {
        const el = document.getElementById(containerId);
        if (!el) {
          window.showToast && window.showToast("Não achei a área para compartilhar.");
          return;
        }

        const toHide = Array.prototype.slice.call(el.querySelectorAll('[data-share-hide="1"]'));
        toHide.forEach(n => n.classList.add("hidden"));

        // garante que ícones estejam renderizados antes da captura
        try { window.lucide && window.lucide.createIcons(); } catch (e) { }

        const canvas = await window.html2canvas(el, {
          backgroundColor: "#F5F5F7",
          scale: 2,
          useCORS: true,
          scrollX: 0,
          scrollY: 0,
          onclone: function (doc) {
            try {
              const cloned = doc.getElementById(containerId);
              if (!cloned) return;
              // Evitar cortes por overflow e truncates
              cloned.style.overflow = "visible";
              cloned.querySelectorAll(".truncate").forEach(n => {
                n.classList.remove("truncate");
                n.style.overflow = "visible";
                n.style.textOverflow = "clip";
                n.style.whiteSpace = "normal";
              });
              // Tabelas dentro de overflow-x-auto: abrir overflow pra capturar tudo sem cortar
              cloned.querySelectorAll(".overflow-x-auto").forEach(n => {
                n.style.overflowX = "visible";
                n.style.overflowY = "visible";
              });
            } catch (e) { }
          },
        });

        toHide.forEach(n => n.classList.remove("hidden"));

        const blob = await new Promise(resolve => canvas.toBlob(resolve, "image/png", 1));
        if (!blob) {
          window.showToast && window.showToast("Não consegui gerar a imagem.");
          return;
        }

        const file = new File([blob], filename || "ranking.png", { type: "image/png" });

        // Sempre mostrar prévia (o usuário pediu para "aparecer a imagem")
        const modal = document.getElementById("shareModal");
        const img = document.getElementById("sharePreviewImg");
        const btnShare = document.getElementById("shareModalShareBtn");
        const btnDownload = document.getElementById("shareModalDownloadBtn");

        const url = URL.createObjectURL(blob);
        if (img) img.src = url;

        window.closeShareModal = function () {
          try { if (modal) modal.classList.add("hidden"); } catch (e) { }
          try { URL.revokeObjectURL(url); } catch (e) { }
        };

        async function tryShareFiles() {
          try {
            if (!navigator.share) return false;
            // Em muitos navegadores, compartilhar arquivo só funciona em contexto seguro (HTTPS/localhost)
            if (window.isSecureContext !== true) return false;
            if (navigator.canShare && navigator.canShare({ files: [file] })) {
              await navigator.share({
                files: [file],
                title: titleText || "Ranking",
                text: titleText || "Ranking",
              });
              window.closeShareModal && window.closeShareModal();
              return true;
            }
            return false;
          } catch (e) {
            return false;
          }
        }

        async function tryShareText() {
          try {
            if (!navigator.share) return false;
            await navigator.share({
              title: titleText || "Ranking",
              text: (titleText || "Ranking") + " (imagem na prévia)",
              url: window.location.href,
            });
            return true;
          } catch (e) {
            return false;
          }
        }

        if (btnShare) {
          btnShare.onclick = async function () {
            const okFiles = await tryShareFiles();
            if (okFiles) return;

            // fallback: tenta ao menos abrir o menu de compartilhar (WhatsApp) com texto/link
            const okText = await tryShareText();
            if (okText) {
              window.showToast && window.showToast("Abrindo compartilhamento (texto/link). Para enviar a imagem, use a prévia.");
              return;
            }

            // sem share API
            const msg = (window.isSecureContext === true)
              ? "Seu navegador não permite compartilhar imagem direto. Use a prévia."
              : "Para compartilhar imagem direto no WhatsApp, geralmente precisa abrir em HTTPS (não em http://IP). Use a prévia.";
            window.showToast && window.showToast(msg);
          };
        }
        if (btnDownload) {
          btnDownload.onclick = function () {
            const a = document.createElement("a");
            a.href = url;
            a.download = filename || "ranking.png";
            document.body.appendChild(a);
            a.click();
            a.remove();
          };
        }

        if (modal) modal.classList.remove("hidden");
        try { window.lucide && window.lucide.createIcons(); } catch (e) { }

        // Tenta abrir o compartilhamento automaticamente (quando suportado)
        const shared = await tryShareFiles();
        if (!shared) {
          // mantém a prévia aberta para o usuário
          const msg = (window.isSecureContext === true)
            ? "Prévia gerada. Toque em Compartilhar."
            : "Prévia gerada. Para compartilhar imagem direto no WhatsApp, use HTTPS; senão use a prévia.";
          window.showToast && window.showToast(msg);
        }
      } catch (e) {
        try {
          window.showToast && window.showToast("Falha ao compartilhar. Tente novamente.");
        } catch (_) { }
        console.error("shareScreenshot error:", e);
      }
    };

    // Dropdown (select → custom)
    function safeInitSelectDropdowns(root) {
      try {
        const selects = Array.prototype.slice.call(root.querySelectorAll("select:not([multiple]):not([data-native='1'])"));
        selects.forEach(sel => {
          if (sel.dataset.ddInit) return;
          sel.dataset.ddInit = "1";
          sel.style.cssText = "position:absolute;opacity:0;pointer-events:none;";

          const wrapper = document.createElement("div");
          wrapper.className = "relative";
          wrapper.style.zIndex = "9998";
          sel.parentNode.insertBefore(wrapper, sel);
          wrapper.appendChild(sel);

          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = "w-full text-left px-4 py-2.5 rounded-md bg-white/40 backdrop-blur-xl border border-slate-300/60 hover-border text-[13px] text-slate-900 cursor-pointer transition-all flex items-center justify-between";
          btn.innerHTML = '<span class="truncate">' + (sel.options[sel.selectedIndex] ? sel.options[sel.selectedIndex].text : "Selecione") + '</span><i data-lucide="chevron-down" class="w-4 h-4 text-slate-500 ml-2 flex-shrink-0"></i>';
          wrapper.appendChild(btn);

          const panel = document.createElement("div");
          // IMPORTANTE: precisa da classe dropdown-panel para conseguirmos fechar outros dropdowns abertos
          panel.className = "dropdown-panel absolute w-full mt-1 rounded-md bg-white/95 backdrop-blur-2xl border border-slate-300/70 shadow-lg max-h-60 overflow-auto hidden";
          panel.style.zIndex = "99999";
          panel.style.position = "absolute";
          wrapper.style.zIndex = "99998";
          wrapper.appendChild(panel);
          // Guardar "dono" do painel (pra conseguir devolver ao lugar quando estiver portaled no body)
          panel.__ddOwner = wrapper;

          function updatePanel() {
            panel.innerHTML = "";
            for (let i = 0; i < sel.options.length; i++) {
              const opt = sel.options[i];
              if (opt.disabled === true) continue;
              const item = document.createElement("div");
              item.className = "px-4 py-2.5 text-[13px] cursor-pointer hover:bg-white/70 transition-all " + (sel.selectedIndex === i ? "bg-emerald-50/70 text-emerald-700 font-medium" : "text-slate-700");
              item.textContent = opt.text;
              item.addEventListener("click", function (e) {
                e.stopPropagation();
                sel.selectedIndex = i;
                sel.dispatchEvent(new Event("change", { bubbles: true }));
                btn.querySelector("span").textContent = opt.text;
                panel.classList.add("hidden");
                panel.style.position = "absolute";
                panel.style.top = "";
                panel.style.left = "";
                panel.style.width = "";
                // Devolver do portal (body) para o wrapper original
                if (panel.__ddOwner && panel.parentNode !== panel.__ddOwner) {
                  panel.__ddOwner.appendChild(panel);
                }
              });
              panel.appendChild(item);
            }
            try { window.lucide && window.lucide.createIcons(); } catch (e) { }
          }
          updatePanel();

          btn.addEventListener("click", function (e) {
            e.stopPropagation();
            const isHidden = panel.classList.contains("hidden");
            document.querySelectorAll(".dropdown-panel").forEach(p => {
              p.classList.add("hidden");
              p.style.position = "absolute";
              p.style.top = "";
              p.style.left = "";
              p.style.width = "";
              // Se o painel estiver portaled no body, devolve pro wrapper original
              if (p.__ddOwner && p.parentNode !== p.__ddOwner) {
                p.__ddOwner.appendChild(p);
              }
            });
            if (isHidden) {
              // Quando abrir, usar portal no body + position:fixed para garantir que fique acima de tudo
              const rect = wrapper.getBoundingClientRect();
              if (panel.parentNode !== document.body) {
                document.body.appendChild(panel);
              }
              panel.style.position = "fixed";
              // position:fixed usa coordenadas do viewport (não somar scrollY)
              panel.style.top = (rect.bottom + 4) + "px";
              panel.style.left = rect.left + "px";
              panel.style.width = rect.width + "px";
              panel.classList.remove("hidden");
            } else {
              panel.classList.add("hidden");
              panel.style.position = "absolute";
              panel.style.top = "";
              panel.style.left = "";
              panel.style.width = "";
              if (panel.__ddOwner && panel.parentNode !== panel.__ddOwner) {
                panel.__ddOwner.appendChild(panel);
              }
            }
          });
          
          // Ajustar posição quando a janela for redimensionada ou rolada
          window.addEventListener("scroll", function() {
            if (!panel.classList.contains("hidden")) {
              const rect = wrapper.getBoundingClientRect();
              panel.style.top = (rect.bottom + 4) + "px";
              panel.style.left = rect.left + "px";
              panel.style.width = rect.width + "px";
            }
          }, true);
          
          window.addEventListener("resize", function() {
            if (!panel.classList.contains("hidden")) {
              const rect = wrapper.getBoundingClientRect();
              panel.style.width = rect.width + "px";
            }
          });

          panel.addEventListener("click", function (e) {
            e.stopPropagation();
          });

          document.addEventListener("click", function () {
            if (!panel.classList.contains("hidden")) {
              panel.classList.add("hidden");
              panel.style.position = "absolute";
              panel.style.top = "";
              panel.style.left = "";
              panel.style.width = "";
              if (panel.__ddOwner && panel.parentNode !== panel.__ddOwner) {
                panel.__ddOwner.appendChild(panel);
              }
            }
          });

          sel.addEventListener("change", updatePanel);
        });
      } catch (e) {
        console.error("Dropdown error:", e);
      }
    }
    document.addEventListener("DOMContentLoaded", () => safeInitSelectDropdowns(document));
    document.body.addEventListener("htmx:afterSwap", (e) => safeInitSelectDropdowns(e.target));
    document.body.addEventListener("htmx:load", (e) => safeInitSelectDropdowns(e.target));

    // Inicializar ícones do bottom nav
    document.addEventListener("DOMContentLoaded", () => {
      if (window.lucide) {
        window.lucide.createIcons();
      }
    });
  </script>
</body>

</html>