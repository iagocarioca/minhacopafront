{% extends "layout/base.html" %}
{% from "layout/card.html" import card %}
{% block breadcrumb %}Time{% endblock %}
{% block page_title %}Time{% endblock %}
{% block content %}
<div class="mb-6">
  <div class="flex items-center justify-between gap-3">
    <div>
      <h2 class="text-lg font-semibold text-slate-900">{{ time.nome }}</h2>
      <div class="mt-1 text-sm text-slate-600 flex items-center gap-2 flex-wrap">
        <span class="inline-flex items-center gap-2 text-[11px] px-2 py-0.5 rounded-full bg-white/60 border border-slate-300/60 text-slate-700">
          <i data-lucide="hash" class="w-3.5 h-3.5"></i>
          {{ time.id }}
        </span>
        {% if time.cor %}
          <span class="inline-flex items-center gap-2 text-[11px] px-2 py-0.5 rounded-full bg-white/60 border border-slate-300/60 text-slate-700">
            <span class="w-1.5 h-1.5 rounded-full bg-slate-400"></span>
            {{ time.cor }}
          </span>
        {% endif %}
      </div>
    </div>
    {% if time.escudo_url %}
      <img src="http://127.0.0.1:5001{{ time.escudo_url }}" alt="{{ time.nome }}" class="w-11 h-11 rounded-lg object-cover border border-slate-300/60" />
    {% else %}
      <div class="w-11 h-11 rounded-lg bg-yellow-50/70 border border-yellow-300/60 grid place-items-center text-yellow-600">
        <i data-lucide="shirt" class="w-5 h-5"></i>
      </div>
    {% endif %}
  </div>
</div>

<div class="grid lg:grid-cols-2 gap-4">
  {% call card("Escalação do Time", (time.jogadores or [])|length ~ " jogadores", "users", "blue") %}
    <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 max-h-[600px] overflow-y-auto pr-2" id="jogadores-list">
      {% include "times/_jogadores_list.html" %}
    </div>
  {% endcall %}

  {% call card("Editar Time", "Configurações do time", "settings", "purple") %}
    <form method="post" enctype="multipart/form-data" class="space-y-3">
      <input type="hidden" name="action" value="update_escudo">
      <div>
        <label class="block text-xs font-semibold text-slate-700 mb-1.5">Escudo do Time</label>
        {% if time.escudo_url %}
          <div class="mb-2">
            <img src="http://127.0.0.1:5001{{ time.escudo_url }}" alt="{{ time.nome }}" class="w-20 h-20 rounded-md object-cover border border-slate-300/60" />
          </div>
        {% endif %}
        <input type="file" name="escudo" accept="image/png,image/jpeg,image/jpg,image/gif,image/webp" class="w-full text-sm px-4 py-2.5 rounded-lg bg-white/40 backdrop-blur-xl text-slate-900 file:mr-4 file:py-1.5 file:px-3 file:rounded-md file:border-0 file:text-xs file:font-medium file:bg-emerald-50 file:text-emerald-700 hover:file:bg-emerald-100" />
      </div>
      <button type="submit" class="w-full h-11 rounded-lg bg-gradient-to-r from-emerald-500 to-emerald-600 hover:from-emerald-600 hover:to-emerald-700 text-white text-sm font-semibold transition-all inline-flex items-center justify-center gap-2">
        <i data-lucide="upload" class="w-4 h-4"></i>
        Atualizar Escudo
      </button>
    </form>
  {% endcall %}

  {% call card("Adicionar Jogador", "Selecione um jogador disponível", "user-plus", "green") %}
    {% if jogadores_disponiveis %}
    <form method="post" 
          hx-post="{{ url_for('times.detalhe', time_id=time.id) }}"
          hx-target="#jogadores-list"
          hx-swap="innerHTML"
          hx-on--after-swap="updateJogadoresCount()"
          hx-on::after-request="if(event.detail.successful) { this.reset(); }"
          class="space-y-3">
      <input type="hidden" name="action" value="add">

      <div>
        <label class="block text-xs font-semibold text-slate-700 mb-1.5">Selecione o jogador</label>
        <select name="jogador_id" required class="w-full text-sm px-4 py-2.5 rounded-lg bg-white/40 backdrop-blur-xl border border-slate-300/60 hover-border text-slate-900 focus:outline-none focus:ring-2 focus:ring-primary-500/20 focus:border-primary-500/40">
          <option value="">-- Escolha um jogador --</option>
          {% for j in jogadores_disponiveis %}
            <option value="{{j.id}}">{{ j.apelido or j.nome_completo }}{% if j.telefone %} ({{ j.telefone }}){% endif %}</option>
          {% endfor %}
        </select>
      </div>

      <div>
        <label class="block text-xs font-semibold text-slate-700 mb-1.5">Posição (opcional)</label>
        <input name="posicao" placeholder="Ex: Atacante, Goleiro, Defesa..." class="w-full text-sm px-4 py-2.5 rounded-lg bg-white/40 backdrop-blur-xl border border-slate-300/60 hover-border text-slate-900 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-primary-500/20 focus:border-primary-500/40" />
      </div>

      <label class="flex items-center gap-3 px-4 py-3 rounded-lg bg-white/40 backdrop-blur-xl border border-slate-300/60 hover-border cursor-pointer transition-all">
        <input type="checkbox" name="capitao" class="rounded border-slate-300 text-primary-600 focus:ring-primary-500/20">
        <span class="text-sm font-semibold text-slate-900">Definir como capitão</span>
      </label>

      <button class="w-full h-11 rounded-lg bg-gradient-to-r from-emerald-500 to-emerald-600 hover:from-emerald-600 hover:to-emerald-700 text-white text-sm font-semibold transition-all inline-flex items-center justify-center gap-2">
        <i data-lucide="plus" class="w-4 h-4"></i>
        Adicionar ao time
      </button>
    </form>
    {% else %}
      <div class="text-center py-8">
        <div class="mb-3 inline-flex items-center justify-center w-11 h-11 rounded-lg bg-orange-50/70 border border-orange-300/60 text-orange-600">
          <i data-lucide="alert-triangle" class="w-5 h-5"></i>
        </div>
        <div class="text-sm text-slate-800 font-semibold">Nenhum jogador disponível</div>
        <div class="text-xs text-slate-600 mt-1">A API não retornou a pelada_id ou não há jogadores cadastrados.</div>
      </div>
    {% endif %}
  {% endcall %}
</div>

<script>
function updateJogadoresCount() {
  const list = document.getElementById('jogadores-list');
  if (!list) return;
  
  const jogadores = list.querySelectorAll('.rounded-lg.bg-white\\/40');
  const count = jogadores.length;
  
  // Atualiza o subtítulo do card
  const card = list.closest('.rounded-md');
  if (card) {
    const subtitle = card.querySelector('.text-xs.text-slate-500');
    if (subtitle) {
      subtitle.textContent = count + ' jogador' + (count !== 1 ? 'es' : '');
    }
  }
  
  // Re-inicializa os ícones Lucide após atualização
  if (typeof lucide !== 'undefined') {
    lucide.createIcons();
  }
}

// Inicializa o contador ao carregar
document.addEventListener('DOMContentLoaded', function() {
  updateJogadoresCount();
  if (typeof lucide !== 'undefined') {
    lucide.createIcons();
  }
});
</script>
{% endblock %}
