{% extends "layout/base.html" %}
{% from "layout/soccer_ball_icon.html" import soccer_ball_icon %}
{% block breadcrumb %}Partida{% endblock %}
{% block page_title %}Detalhes da Partida{% endblock %}
{% block content %}
{% set _rodada_id = rodada_id or (partida.rodada_id if partida.rodada_id is defined else (partida.rodada.id if partida.rodada and partida.rodada.id is defined else None)) %}
{% if _rodada_id %}<div data-rodada-id="{{ _rodada_id }}" class="hidden"></div>{% endif %}
{% set casa = partida.time_casa_full or partida.time_casa or {} %}
{% set fora = partida.time_fora_full or partida.time_fora or {} %}

<!-- Placar principal -->
<div class="mb-4">
  <div id="placar">
    {% include "partidas/_placar.html" %}
  </div>
</div>

<!-- Sumário -->
<div>
    <!-- Timeline de eventos -->
    <div class="mb-6">
      <div class="bg-white rounded-lg border border-slate-200 overflow-hidden">
        <div class="px-4 py-3 border-b border-slate-100">
          <h3 class="text-sm font-semibold text-slate-900">Linha do Tempo</h3>
        </div>
        <div id="timeline" class="divide-y divide-slate-100">
          {% include "partidas/_timeline.html" %}
        </div>
      </div>
    </div>

    <!-- Registrar gol (se partida em andamento) -->
    {% if partida.status == "em_andamento" %}
    <div class="mb-6 bg-white rounded-lg border border-slate-200 overflow-hidden">
      <div class="px-4 py-3 border-b border-slate-100">
        <h3 class="text-sm font-semibold text-slate-900">Registrar Gol</h3>
      </div>
      <div class="p-4">
        <form
          hx-post="/partidas/{{partida.id}}/gol"
          hx-target="#placar"
          hx-swap="outerHTML"
          class="space-y-4"
          id="golForm"
        >
          <div>
            <label class="block text-xs font-medium text-slate-700 mb-1.5">Time</label>
            <select name="time_id" id="timeSelect" class="w-full text-sm px-3 py-2.5 rounded-md border border-slate-300 bg-white text-slate-900 focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500">
              {% if casa.id %}<option value="{{casa.id}}" data-time="casa">{{ casa.nome or "Casa" }}</option>{% endif %}
              {% if fora.id %}<option value="{{fora.id}}" data-time="fora">{{ fora.nome or "Fora" }}</option>{% endif %}
            </select>
          </div>

          {% set jogadores_casa = casa.jogadores or [] %}
          {% set jogadores_fora = fora.jogadores or [] %}

          <div>
            <label class="block text-xs font-medium text-slate-700 mb-1.5">Jogador que marcou</label>
            <select name="jogador_id" id="jogadorSelect" class="w-full text-sm px-3 py-2.5 rounded-md border border-slate-300 bg-white text-slate-900 focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500">
              {% for j in jogadores_casa %}
                <option value="{{ j.id }}" data-time="casa">{{ j.apelido or j.nome_completo }}</option>
              {% endfor %}
              {% for j in jogadores_fora %}
                <option value="{{ j.id }}" data-time="fora">{{ j.apelido or j.nome_completo }}</option>
              {% endfor %}
            </select>
          </div>

          <div>
            <label class="block text-xs font-medium text-slate-700 mb-1.5">Assistência (opcional)</label>
            <select name="assistencia_id" id="assistenciaSelect" class="w-full text-sm px-3 py-2.5 rounded-md border border-slate-300 bg-white text-slate-900 focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500">
              <option value="">Sem assistência</option>
              {% for j in jogadores_casa %}
                <option value="{{ j.id }}" data-time="casa">{{ j.apelido or j.nome_completo }}</option>
              {% endfor %}
              {% for j in jogadores_fora %}
                <option value="{{ j.id }}" data-time="fora">{{ j.apelido or j.nome_completo }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-xs font-medium text-slate-700 mb-1.5">Minuto</label>
              <div class="relative">
                <input name="minuto" id="minutoInput" placeholder="Ex: 15" class="w-full text-sm px-3 py-2.5 rounded-md border border-slate-300 bg-white text-slate-900 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500" />
                {% if partida.status == 'em_andamento' %}
                <button type="button" id="useTimerBtn" class="absolute right-2 top-1/2 -translate-y-1/2 text-[10px] font-medium text-emerald-600 hover:text-emerald-700 px-2 py-1 rounded border border-emerald-200 bg-emerald-50/50 hover:bg-emerald-50 transition-all">
                  Usar tempo
                </button>
                {% endif %}
              </div>
            </div>
            <div>
              <label class="block text-xs font-medium text-slate-700 mb-1.5">&nbsp;</label>
              <label class="flex items-center gap-2 px-3 py-2.5 rounded-md border border-slate-300 bg-white cursor-pointer transition-all">
                <input type="checkbox" name="gol_contra" class="rounded border-slate-300 text-blue-600 focus:ring-blue-500/20">
                <span class="text-xs font-medium text-slate-700">Gol contra</span>
              </label>
            </div>
          </div>

          <button type="submit" class="w-full h-10 rounded-md bg-blue-500 hover:bg-blue-600 text-white text-sm font-medium transition-all inline-flex items-center justify-center gap-2">
            {{ soccer_ball_icon("w-4 h-4", "white", "") }}
            Adicionar gol
          </button>
        </form>
      </div>
    </div>
    {% endif %}
</div>

<script>

(function() {
  // Timer de partida
  let timerInterval = null;
  let startTime = null;
  let elapsedSeconds = 0;
  let isPaused = false;
  
  function initTimer() {
    const timerElement = document.getElementById('timer');
    if (!timerElement) return;
    
    // Verifica se a partida está em andamento
    const partidaStatus = '{{ partida.status }}';
    if (partidaStatus !== 'em_andamento') return;
    
    // Inicia o timer a partir de 00:00
    startTime = Date.now();
    elapsedSeconds = 0;
    isPaused = false;
    
    function updateTimer() {
      if (isPaused) return;
      
      elapsedSeconds = Math.floor((Date.now() - startTime) / 1000);
      const minutes = Math.floor(elapsedSeconds / 60);
      const seconds = elapsedSeconds % 60;
      
      const formatted = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
      if (timerElement) {
        timerElement.textContent = formatted;
      }
    }
    
    timerInterval = setInterval(updateTimer, 1000);
    updateTimer();
  }
  
  // Botão para usar o tempo atual no campo de minuto
  function initUseTimerButton() {
    const useTimerBtn = document.getElementById('useTimerBtn');
    const minutoInput = document.getElementById('minutoInput');
    
    if (useTimerBtn && minutoInput) {
      useTimerBtn.addEventListener('click', function() {
        if (elapsedSeconds !== null) {
          const minutes = Math.floor(elapsedSeconds / 60);
          minutoInput.value = minutes;
          // Feedback visual
          useTimerBtn.textContent = '✓ Usado';
          useTimerBtn.classList.add('bg-emerald-100', 'border-emerald-300');
          setTimeout(() => {
            useTimerBtn.textContent = 'Usar tempo';
            useTimerBtn.classList.remove('bg-emerald-100', 'border-emerald-300');
          }, 1500);
        }
      });
    }
  }
  
  // Filtro de jogadores
  const allJogadores = {};
  const allAssistencias = {};
  
  function initFilter() {
    const timeSelect = document.getElementById('timeSelect');
    const jogadorSelect = document.getElementById('jogadorSelect');
    const assistenciaSelect = document.getElementById('assistenciaSelect');
    
    if (!timeSelect || !jogadorSelect || !assistenciaSelect) {
      setTimeout(initFilter, 500);
      return;
    }
    
    Array.from(jogadorSelect.options).forEach(opt => {
      if (!allJogadores[opt.value]) {
        allJogadores[opt.value] = {
          element: opt.cloneNode(true),
          time: opt.getAttribute('data-time')
        };
      }
    });
    
    Array.from(assistenciaSelect.options).forEach(opt => {
      if (!allAssistencias[opt.value]) {
        allAssistencias[opt.value] = {
          element: opt.cloneNode(true),
          time: opt.getAttribute('data-time')
        };
      }
    });
    
    function filterJogadores(selectElement, allOptions, selectedTime) {
      const selectedValue = selectElement.value;
      const firstOption = selectElement.options[0];
      const isFirstEmpty = firstOption && firstOption.value === '';
      
      selectElement.innerHTML = '';
      
      if (isFirstEmpty) {
        selectElement.appendChild(firstOption.cloneNode(true));
      }
      
      Object.keys(allOptions).forEach(value => {
        const optData = allOptions[value];
        if (optData.time === selectedTime) {
          selectElement.appendChild(optData.element.cloneNode(true));
        }
      });
      
      if (selectElement.dataset.ddInit) {
        const event = new Event('change', { bubbles: true });
        selectElement.dispatchEvent(event);
      }
      
      if (selectedValue && Array.from(selectElement.options).some(opt => opt.value === selectedValue)) {
        selectElement.value = selectedValue;
      } else {
        selectElement.value = '';
      }
    }
    
    function updateJogadores() {
      const selectedOption = timeSelect.options[timeSelect.selectedIndex];
      if (!selectedOption) return;
      
      const selectedTime = selectedOption.getAttribute('data-time');
      if (!selectedTime) return;
      
      filterJogadores(jogadorSelect, allJogadores, selectedTime);
      filterJogadores(assistenciaSelect, allAssistencias, selectedTime);
    }
    
    updateJogadores();
    timeSelect.addEventListener('change', updateJogadores);
    
    document.body.addEventListener('htmx:afterSwap', function(e) {
      if (e.target.querySelector('#timeSelect')) {
        setTimeout(initFilter, 100);
      }
      // Reinicia o timer se o placar foi atualizado
      if (e.target.querySelector('#timer')) {
        clearInterval(timerInterval);
        initTimer();
      }
    });
  }
  
  // Inicialização
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
      initTimer();
      initUseTimerButton();
      initFilter();
    });
  } else {
    initTimer();
    initUseTimerButton();
    initFilter();
  }
  
  // Limpa o timer ao sair da página
  window.addEventListener('beforeunload', function() {
    if (timerInterval) {
      clearInterval(timerInterval);
    }
  });
})();
</script>

<style>
.scrollbar-hide {
  -ms-overflow-style: none;
  scrollbar-width: none;
}
.scrollbar-hide::-webkit-scrollbar {
  display: none;
}
</style>

{% endblock %}
