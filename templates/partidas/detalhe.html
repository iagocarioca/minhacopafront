{% extends "layout/base.html" %}
{% from "layout/soccer_ball_icon.html" import soccer_ball_icon %}
{% block breadcrumb %}Partida{% endblock %}
{% block page_title %}Detalhes da Partida{% endblock %}
{% block content %}
{% set _rodada_id = rodada_id or (partida.rodada_id if partida.rodada_id is defined else (partida.rodada.id if partida.rodada and partida.rodada.id is defined else None)) %}
{% if _rodada_id %}<div data-rodada-id="{{ _rodada_id }}" class="hidden"></div>{% endif %}
{% set casa = partida.time_casa_full or partida.time_casa or {} %}
{% set fora = partida.time_fora_full or partida.time_fora or {} %}

<!-- Placar principal -->
<div class="mb-4">
  <div id="placar">
    {% include "partidas/_placar.html" %}
  </div>
</div>

<!-- Tabs principais (Match, H2H, Standings, News) -->
<div class="mb-4 border-b border-slate-200">
  <div class="flex items-center gap-1 overflow-x-auto pb-0 scrollbar-hide">
    <button onclick="showMainTab('match')" id="main-tab-match" class="main-tab-btn active px-4 py-3 text-sm font-medium text-slate-900 border-b-2 border-blue-500 transition-all whitespace-nowrap">
      Match
    </button>
    <button onclick="showMainTab('h2h')" id="main-tab-h2h" class="main-tab-btn px-4 py-3 text-sm font-medium text-slate-500 border-b-2 border-transparent hover:text-slate-700 transition-all whitespace-nowrap">
      H2H
    </button>
    <button onclick="showMainTab('standings')" id="main-tab-standings" class="main-tab-btn px-4 py-3 text-sm font-medium text-slate-500 border-b-2 border-transparent hover:text-slate-700 transition-all whitespace-nowrap">
      Standings
    </button>
  </div>
</div>

<!-- Conteúdo: Match Tab -->
<div id="main-content-match" class="main-tab-content">
  <!-- Sub-tabs (Summary, Statistics, Lineup) -->
  <div class="mb-4">
    <div class="flex items-center gap-1 overflow-x-auto pb-0 scrollbar-hide">
      <button onclick="showSubTab('summary')" id="sub-tab-summary" class="sub-tab-btn active px-4 py-2.5 text-xs font-medium text-slate-900 border-b-2 border-blue-500 transition-all whitespace-nowrap">
        Summary
      </button>
      <button onclick="showSubTab('statistics')" id="sub-tab-statistics" class="sub-tab-btn px-4 py-2.5 text-xs font-medium text-slate-500 border-b-2 border-transparent hover:text-slate-700 transition-all whitespace-nowrap">
        Statistics
      </button>
      <button onclick="showSubTab('lineup')" id="sub-tab-lineup" class="sub-tab-btn px-4 py-2.5 text-xs font-medium text-slate-500 border-b-2 border-transparent hover:text-slate-700 transition-all whitespace-nowrap">
        Lineup
      </button>
    </div>
  </div>

  <!-- Sub-tab Content: Summary -->
  <div id="sub-content-summary" class="sub-tab-content">
    <!-- Timeline de eventos (estilo imagem) -->
    <div class="mb-6">
      <div class="bg-white rounded-lg border border-slate-200 overflow-hidden">
        <div class="px-4 py-3 border-b border-slate-100">
          <h3 class="text-sm font-semibold text-slate-900">Timeline</h3>
        </div>
        <div id="timeline" class="divide-y divide-slate-100">
          {% include "partidas/_timeline.html" %}
        </div>
      </div>
    </div>

    <!-- Registrar gol (se partida em andamento) -->
    {% if partida.status == "em_andamento" %}
    <div class="mb-6 bg-white rounded-lg border border-slate-200 overflow-hidden">
      <div class="px-4 py-3 border-b border-slate-100">
        <h3 class="text-sm font-semibold text-slate-900">Registrar Gol</h3>
      </div>
      <div class="p-4">
        <form
          hx-post="/partidas/{{partida.id}}/gol"
          hx-target="#placar"
          hx-swap="outerHTML"
          class="space-y-4"
          id="golForm"
        >
          <div>
            <label class="block text-xs font-medium text-slate-700 mb-1.5">Time</label>
            <select name="time_id" id="timeSelect" class="w-full text-sm px-3 py-2.5 rounded-md border border-slate-300 bg-white text-slate-900 focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500">
              {% if casa.id %}<option value="{{casa.id}}" data-time="casa">{{ casa.nome or "Casa" }}</option>{% endif %}
              {% if fora.id %}<option value="{{fora.id}}" data-time="fora">{{ fora.nome or "Fora" }}</option>{% endif %}
            </select>
          </div>

          {% set jogadores_casa = casa.jogadores or [] %}
          {% set jogadores_fora = fora.jogadores or [] %}

          <div>
            <label class="block text-xs font-medium text-slate-700 mb-1.5">Jogador que marcou</label>
            <select name="jogador_id" id="jogadorSelect" class="w-full text-sm px-3 py-2.5 rounded-md border border-slate-300 bg-white text-slate-900 focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500">
              {% for j in jogadores_casa %}
                <option value="{{ j.id }}" data-time="casa">{{ j.apelido or j.nome_completo }}</option>
              {% endfor %}
              {% for j in jogadores_fora %}
                <option value="{{ j.id }}" data-time="fora">{{ j.apelido or j.nome_completo }}</option>
              {% endfor %}
            </select>
          </div>

          <div>
            <label class="block text-xs font-medium text-slate-700 mb-1.5">Assistência (opcional)</label>
            <select name="assistencia_id" id="assistenciaSelect" class="w-full text-sm px-3 py-2.5 rounded-md border border-slate-300 bg-white text-slate-900 focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500">
              <option value="">Sem assistência</option>
              {% for j in jogadores_casa %}
                <option value="{{ j.id }}" data-time="casa">{{ j.apelido or j.nome_completo }}</option>
              {% endfor %}
              {% for j in jogadores_fora %}
                <option value="{{ j.id }}" data-time="fora">{{ j.apelido or j.nome_completo }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-xs font-medium text-slate-700 mb-1.5">Minuto</label>
              <input name="minuto" placeholder="Ex: 15" class="w-full text-sm px-3 py-2.5 rounded-md border border-slate-300 bg-white text-slate-900 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500" />
            </div>
            <div>
              <label class="block text-xs font-medium text-slate-700 mb-1.5">&nbsp;</label>
              <label class="flex items-center gap-2 px-3 py-2.5 rounded-md border border-slate-300 bg-white cursor-pointer transition-all">
                <input type="checkbox" name="gol_contra" class="rounded border-slate-300 text-blue-600 focus:ring-blue-500/20">
                <span class="text-xs font-medium text-slate-700">Gol contra</span>
              </label>
            </div>
          </div>

          <button class="w-full h-10 rounded-md bg-blue-500 hover:bg-blue-600 text-white text-sm font-medium transition-all inline-flex items-center justify-center gap-2">
            {{ soccer_ball_icon("w-4 h-4", "white", "") }}
            Adicionar gol
          </button>
        </form>
      </div>
    </div>
    {% endif %}
  </div>

  <!-- Sub-tab Content: Statistics -->
  <div id="sub-content-statistics" class="sub-tab-content hidden">
    <div class="bg-white rounded-lg border border-slate-200 overflow-hidden">
      <div class="px-4 py-3 border-b border-slate-100">
        <h3 class="text-sm font-semibold text-slate-900">TEAM STATS</h3>
      </div>
      <div class="p-4 space-y-4">
        <!-- Ball Possession -->
        <div>
          <div class="flex items-center justify-between mb-2">
            <span class="text-xs font-medium text-slate-700">{{ casa.nome or "Casa" }}</span>
            <span class="text-xs font-medium text-slate-700">Ball Possession</span>
            <span class="text-xs font-medium text-slate-700">{{ fora.nome or "Fora" }}</span>
          </div>
          <div class="flex items-center gap-2">
            <div class="flex-1 h-2 bg-slate-200 rounded-full overflow-hidden">
              <div class="h-full bg-blue-500" style="width: 50%"></div>
            </div>
            <span class="text-xs font-semibold text-slate-900 w-12 text-center">50%</span>
            <div class="flex-1 h-2 bg-slate-200 rounded-full overflow-hidden">
              <div class="h-full bg-red-500 ml-auto" style="width: 50%"></div>
            </div>
          </div>
        </div>

        <!-- Shots -->
        <div>
          <div class="flex items-center justify-between mb-2">
            <span class="text-xs font-medium text-slate-700">{{ casa.nome or "Casa" }}</span>
            <span class="text-xs font-medium text-slate-700">Shots</span>
            <span class="text-xs font-medium text-slate-700">{{ fora.nome or "Fora" }}</span>
          </div>
          <div class="flex items-center gap-2">
            <div class="flex-1 h-2 bg-slate-200 rounded-full overflow-hidden">
              <div class="h-full bg-blue-500" style="width: 68%"></div>
            </div>
            <span class="text-xs font-semibold text-slate-900 w-12 text-center">15</span>
            <div class="flex-1 h-2 bg-slate-200 rounded-full overflow-hidden">
              <div class="h-full bg-red-500 ml-auto" style="width: 32%"></div>
            </div>
          </div>
        </div>

        <!-- Placeholder para outras estatísticas -->
        <div class="text-center py-8 text-xs text-slate-500">
          Mais estatísticas em breve
        </div>
      </div>
    </div>
  </div>

  <!-- Sub-tab Content: Lineup -->
  <div id="sub-content-lineup" class="sub-tab-content hidden">
    <div class="space-y-6">
      <!-- Time Casa -->
      <div class="bg-white rounded-lg border border-slate-200 overflow-hidden">
        <div class="px-4 py-3 border-b border-slate-100">
          <h3 class="text-sm font-semibold text-slate-900">{{ casa.nome or "Casa" }}</h3>
        </div>
        <div class="p-4">
          {% if casa.jogadores and casa.jogadores|length %}
            <div class="space-y-2">
              {% for j in casa.jogadores %}
                <div class="flex items-center gap-3 py-2">
                  {% if j.foto_url %}
                    <img src="http://192.168.18.38:5001{{ j.foto_url }}" alt="{{ j.apelido or j.nome_completo }}" class="w-8 h-8 rounded-full object-cover flex-shrink-0 border border-slate-200" />
                  {% else %}
                    <div class="w-8 h-8 rounded-full bg-slate-100 grid place-items-center text-xs font-semibold text-slate-600 flex-shrink-0">
                      {{ loop.index }}
                    </div>
                  {% endif %}
                  <div class="flex-1">
                    <div class="text-sm font-medium text-slate-900">{{ j.apelido or j.nome_completo }}</div>
                    {% if j.posicao %}
                      <div class="text-xs text-slate-500">{{ j.posicao }}</div>
                    {% endif %}
                  </div>
                </div>
              {% endfor %}
            </div>
          {% else %}
            <div class="text-center py-8 text-xs text-slate-500">Nenhum jogador cadastrado</div>
          {% endif %}
        </div>
      </div>

      <!-- Time Fora -->
      <div class="bg-white rounded-lg border border-slate-200 overflow-hidden">
        <div class="px-4 py-3 border-b border-slate-100">
          <h3 class="text-sm font-semibold text-slate-900">{{ fora.nome or "Fora" }}</h3>
        </div>
        <div class="p-4">
          {% if fora.jogadores and fora.jogadores|length %}
            <div class="space-y-2">
              {% for j in fora.jogadores %}
                <div class="flex items-center gap-3 py-2">
                  {% if j.foto_url %}
                    <img src="http://192.168.18.38:5001{{ j.foto_url }}" alt="{{ j.apelido or j.nome_completo }}" class="w-8 h-8 rounded-full object-cover flex-shrink-0 border border-slate-200" />
                  {% else %}
                    <div class="w-8 h-8 rounded-full bg-slate-100 grid place-items-center text-xs font-semibold text-slate-600 flex-shrink-0">
                      {{ loop.index }}
                    </div>
                  {% endif %}
                  <div class="flex-1">
                    <div class="text-sm font-medium text-slate-900">{{ j.apelido or j.nome_completo }}</div>
                    {% if j.posicao %}
                      <div class="text-xs text-slate-500">{{ j.posicao }}</div>
                    {% endif %}
                  </div>
                </div>
              {% endfor %}
            </div>
          {% else %}
            <div class="text-center py-8 text-xs text-slate-500">Nenhum jogador cadastrado</div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Conteúdo: H2H Tab -->
<div id="main-content-h2h" class="main-tab-content hidden">
  <div class="bg-white rounded-lg border border-slate-200 overflow-hidden">
    <div class="px-4 py-3 border-b border-slate-100">
      <h3 class="text-sm font-semibold text-slate-900">Head to Head</h3>
    </div>
    <div class="p-4">
      <div class="text-center py-12">
        <div class="text-sm text-slate-800 font-medium">Histórico em breve</div>
        <div class="text-xs text-slate-500 mt-1.5">O histórico de confrontos estará disponível em breve.</div>
      </div>
    </div>
  </div>
</div>

<!-- Conteúdo: Standings Tab -->
<div id="main-content-standings" class="main-tab-content hidden">
  <div class="bg-white rounded-lg border border-slate-200 overflow-hidden">
    <div class="px-4 py-3 border-b border-slate-100">
      <h3 class="text-sm font-semibold text-slate-900">Standings</h3>
    </div>
    <div class="p-4">
      <div class="text-center py-12">
        <div class="text-sm text-slate-800 font-medium">Tabela em breve</div>
        <div class="text-xs text-slate-500 mt-1.5">A tabela de classificação estará disponível em breve.</div>
      </div>
    </div>
  </div>
</div>

<script>
function showMainTab(tabName) {
  // Esconde todos os conteúdos principais
  document.querySelectorAll('.main-tab-content').forEach(content => {
    content.classList.add('hidden');
  });
  
  // Remove active de todas as tabs principais
  document.querySelectorAll('.main-tab-btn').forEach(btn => {
    btn.classList.remove('active', 'text-slate-900', 'border-blue-500');
    btn.classList.add('text-slate-500', 'border-transparent');
  });
  
  // Mostra o conteúdo selecionado
  const content = document.getElementById('main-content-' + tabName);
  if (content) {
    content.classList.remove('hidden');
  }
  
  // Ativa a tab selecionada
  const tab = document.getElementById('main-tab-' + tabName);
  if (tab) {
    tab.classList.add('active', 'text-slate-900', 'border-blue-500');
    tab.classList.remove('text-slate-500', 'border-transparent');
  }
  
  // Reinicializa ícones Lucide
  if (window.lucide) {
    window.lucide.createIcons();
  }
}

function showSubTab(tabName) {
  // Esconde todos os conteúdos de sub-tabs
  document.querySelectorAll('.sub-tab-content').forEach(content => {
    content.classList.add('hidden');
  });
  
  // Remove active de todas as sub-tabs
  document.querySelectorAll('.sub-tab-btn').forEach(btn => {
    btn.classList.remove('active', 'text-slate-900', 'border-blue-500');
    btn.classList.add('text-slate-500', 'border-transparent');
  });
  
  // Mostra o conteúdo selecionado
  const content = document.getElementById('sub-content-' + tabName);
  if (content) {
    content.classList.remove('hidden');
  }
  
  // Ativa a sub-tab selecionada
  const tab = document.getElementById('sub-tab-' + tabName);
  if (tab) {
    tab.classList.add('active', 'text-slate-900', 'border-blue-500');
    tab.classList.remove('text-slate-500', 'border-transparent');
  }
  
  // Reinicializa ícones Lucide
  if (window.lucide) {
    window.lucide.createIcons();
  }
}

(function() {
  const allJogadores = {};
  const allAssistencias = {};
  
  function initFilter() {
    const timeSelect = document.getElementById('timeSelect');
    const jogadorSelect = document.getElementById('jogadorSelect');
    const assistenciaSelect = document.getElementById('assistenciaSelect');
    
    if (!timeSelect || !jogadorSelect || !assistenciaSelect) {
      setTimeout(initFilter, 500);
      return;
    }
    
    Array.from(jogadorSelect.options).forEach(opt => {
      if (!allJogadores[opt.value]) {
        allJogadores[opt.value] = {
          element: opt.cloneNode(true),
          time: opt.getAttribute('data-time')
        };
      }
    });
    
    Array.from(assistenciaSelect.options).forEach(opt => {
      if (!allAssistencias[opt.value]) {
        allAssistencias[opt.value] = {
          element: opt.cloneNode(true),
          time: opt.getAttribute('data-time')
        };
      }
    });
    
    function filterJogadores(selectElement, allOptions, selectedTime) {
      const selectedValue = selectElement.value;
      const firstOption = selectElement.options[0];
      const isFirstEmpty = firstOption && firstOption.value === '';
      
      selectElement.innerHTML = '';
      
      if (isFirstEmpty) {
        selectElement.appendChild(firstOption.cloneNode(true));
      }
      
      Object.keys(allOptions).forEach(value => {
        const optData = allOptions[value];
        if (optData.time === selectedTime) {
          selectElement.appendChild(optData.element.cloneNode(true));
        }
      });
      
      if (selectElement.dataset.ddInit) {
        const event = new Event('change', { bubbles: true });
        selectElement.dispatchEvent(event);
      }
      
      if (selectedValue && Array.from(selectElement.options).some(opt => opt.value === selectedValue)) {
        selectElement.value = selectedValue;
      } else {
        selectElement.value = '';
      }
    }
    
    function updateJogadores() {
      const selectedOption = timeSelect.options[timeSelect.selectedIndex];
      if (!selectedOption) return;
      
      const selectedTime = selectedOption.getAttribute('data-time');
      if (!selectedTime) return;
      
      filterJogadores(jogadorSelect, allJogadores, selectedTime);
      filterJogadores(assistenciaSelect, allAssistencias, selectedTime);
    }
    
    updateJogadores();
    timeSelect.addEventListener('change', updateJogadores);
    
    document.body.addEventListener('htmx:afterSwap', function(e) {
      if (e.target.querySelector('#timeSelect')) {
        setTimeout(initFilter, 100);
      }
    });
  }
  
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initFilter);
  } else {
    initFilter();
  }
})();
</script>

<style>
.scrollbar-hide {
  -ms-overflow-style: none;
  scrollbar-width: none;
}
.scrollbar-hide::-webkit-scrollbar {
  display: none;
}
</style>

{% endblock %}
