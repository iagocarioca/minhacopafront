{% extends "layout/base.html" %}
{% from "layout/card.html" import card %}
{% from "layout/soccer_ball_icon.html" import soccer_ball_icon %}
{% block breadcrumb %}Partida{% endblock %}
{% block page_title %}Detalhes da Partida{% endblock %}
{% block content %}
{% set casa = partida.time_casa_full or partida.time_casa or {} %}
{% set fora = partida.time_fora_full or partida.time_fora or {} %}

<!-- Placar principal -->
<div class="mb-6">
  <div id="placar">
    {% include "partidas/_placar.html" %}
  </div>
</div>

<!-- Tabs Navigation -->
<div class="mb-6">
  <div class="flex items-center gap-2 overflow-x-auto pb-2 scrollbar-hide">
    <button onclick="showPartidaTab('summary')" id="tab-summary" class="tab-partida-btn active px-4 py-2.5 rounded-md text-xs font-medium text-white bg-emerald-500 transition-all whitespace-nowrap">
      <i data-lucide="file-text" class="w-3.5 h-3.5 inline-block mr-1.5"></i>
      Resumo
    </button>
    <button onclick="showPartidaTab('stats')" id="tab-stats" class="tab-partida-btn px-4 py-2.5 rounded-md text-xs font-medium text-slate-600 bg-white/60 backdrop-blur-xl hover:bg-white/80 transition-all whitespace-nowrap">
      <i data-lucide="bar-chart-3" class="w-3.5 h-3.5 inline-block mr-1.5"></i>
      Estatísticas
    </button>
    <button onclick="showPartidaTab('lineups')" id="tab-lineups" class="tab-partida-btn px-4 py-2.5 rounded-md text-xs font-medium text-slate-600 bg-white/60 backdrop-blur-xl hover:bg-white/80 transition-all whitespace-nowrap">
      <i data-lucide="users" class="w-3.5 h-3.5 inline-block mr-1.5"></i>
      Escalações
    </button>
    <button onclick="showPartidaTab('h2h')" id="tab-h2h" class="tab-partida-btn px-4 py-2.5 rounded-md text-xs font-medium text-slate-600 bg-white/60 backdrop-blur-xl hover:bg-white/80 transition-all whitespace-nowrap">
      <i data-lucide="git-compare" class="w-3.5 h-3.5 inline-block mr-1.5"></i>
      Confrontos
    </button>
  </div>
</div>

<!-- Tab Content: Summary -->
<div id="content-summary" class="tab-partida-content">
  <div class="grid lg:grid-cols-2 gap-6">
    <!-- Registrar gol -->
    {% call card("Registrar Gol", "Adicione os gols da partida", "target", "blue") %}
      {% if partida.status == "em_andamento" %}
      <form
        hx-post="/partidas/{{partida.id}}/gol"
        hx-target="#placar"
        hx-swap="outerHTML"
        class="space-y-4"
        id="golForm"
      >
        <div>
          <label class="block text-xs font-semibold text-slate-700 mb-2">Time</label>
          <select name="time_id" id="timeSelect" class="w-full text-sm px-4 py-3 rounded-md bg-white/60 backdrop-blur-xl text-slate-900">
            {% if casa.id %}<option value="{{casa.id}}" data-time="casa">{{ casa.nome or "Casa" }}</option>{% endif %}
            {% if fora.id %}<option value="{{fora.id}}" data-time="fora">{{ fora.nome or "Fora" }}</option>{% endif %}
          </select>
        </div>

        {% set jogadores_casa = casa.jogadores or [] %}
        {% set jogadores_fora = fora.jogadores or [] %}

        <div>
          <label class="block text-xs font-semibold text-slate-700 mb-2">Jogador que marcou</label>
          <select name="jogador_id" id="jogadorSelect" class="w-full text-sm px-4 py-3 rounded-md bg-white/60 backdrop-blur-xl text-slate-900">
            {% for j in jogadores_casa %}
              <option value="{{ j.id }}" data-time="casa">{{ j.apelido or j.nome_completo }}</option>
            {% endfor %}
            {% for j in jogadores_fora %}
              <option value="{{ j.id }}" data-time="fora">{{ j.apelido or j.nome_completo }}</option>
            {% endfor %}
          </select>
        </div>

        <div>
          <label class="block text-xs font-semibold text-slate-700 mb-2">Assistência (opcional)</label>
          <select name="assistencia_id" id="assistenciaSelect" class="w-full text-sm px-4 py-3 rounded-md bg-white/60 backdrop-blur-xl text-slate-900">
            <option value="">Sem assistência</option>
            {% for j in jogadores_casa %}
              <option value="{{ j.id }}" data-time="casa">{{ j.apelido or j.nome_completo }}</option>
            {% endfor %}
            {% for j in jogadores_fora %}
              <option value="{{ j.id }}" data-time="fora">{{ j.apelido or j.nome_completo }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-xs font-semibold text-slate-700 mb-2">Minuto</label>
            <input name="minuto" placeholder="Ex: 15" class="w-full text-sm px-4 py-3 rounded-md bg-white/60 backdrop-blur-xl text-slate-900 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-primary-500/30" />
          </div>
          <div>
            <label class="block text-xs font-semibold text-slate-700 mb-2">&nbsp;</label>
            <label class="flex items-center gap-2 px-4 py-3 rounded-md bg-white/60 backdrop-blur-xl cursor-pointer transition-all">
              <input type="checkbox" name="gol_contra" class="rounded border-slate-300 text-primary-600 focus:ring-primary-500/30">
              <span class="text-xs font-semibold text-slate-700">Gol contra</span>
            </label>
          </div>
        </div>

        <button class="w-full h-12 rounded-md bg-gradient-to-r from-primary-500 to-primary-600 hover:from-primary-600 hover:to-primary-700 text-white text-sm font-semibold transition-all inline-flex items-center justify-center gap-2">
          {{ soccer_ball_icon("w-4 h-4", "white", "") }}
          Adicionar gol
        </button>
      </form>
      {% else %}
        <div class="text-center py-12">
          <div class="mb-4 inline-flex items-center justify-center w-14 h-14 rounded-md bg-slate-50/80 text-slate-400">
            <i data-lucide="info" class="w-6 h-6"></i>
          </div>
          <div class="text-sm text-slate-800 font-semibold">Partida não está em andamento</div>
          <div class="text-xs text-slate-500 mt-1.5">Inicie a partida para registrar gols.</div>
        </div>
      {% endif %}
    {% endcall %}

    <!-- Timeline -->
    {% call card("Timeline de Gols", "Histórico da partida", "list", "green") %}
      <div id="timeline">
        {% include "partidas/_timeline.html" %}
      </div>
    {% endcall %}
  </div>
</div>

<!-- Tab Content: Stats -->
<div id="content-stats" class="tab-partida-content hidden">
  {% call card("Estatísticas da Partida", "Dados detalhados", "bar-chart-3", "purple") %}
    <div class="text-center py-12">
      <div class="mb-4 inline-flex items-center justify-center w-14 h-14 rounded-md bg-purple-50/80 text-purple-400">
        <i data-lucide="bar-chart-3" class="w-6 h-6"></i>
      </div>
      <div class="text-sm text-slate-800 font-semibold">Estatísticas em breve</div>
      <div class="text-xs text-slate-500 mt-1.5">As estatísticas detalhadas estarão disponíveis em breve.</div>
    </div>
  {% endcall %}
</div>

<!-- Tab Content: Lineups -->
<div id="content-lineups" class="tab-partida-content hidden">
  <div class="grid lg:grid-cols-2 gap-6">
    {% call card("Escalação - " ~ (casa.nome or "Casa"), "Jogadores do time da casa", "users", "blue") %}
      {% if casa.jogadores and casa.jogadores|length %}
        <div class="space-y-2">
          {% for j in casa.jogadores %}
            <div class="rounded-md bg-white/60 backdrop-blur-xl p-3 flex items-center gap-3">
              {% if j.foto_url %}
                <img src="http://127.0.0.1:5001{{ j.foto_url }}" alt="{{ j.apelido or j.nome_completo }}" class="w-8 h-8 rounded-md object-cover flex-shrink-0 border border-slate-300/60" />
              {% else %}
                <div class="w-8 h-8 rounded-md bg-emerald-50/80 text-emerald-600 grid place-items-center text-xs font-semibold flex-shrink-0">
                  {{ loop.index }}
                </div>
              {% endif %}
              <div class="flex-1">
                <div class="text-sm font-medium text-slate-900">{{ j.apelido or j.nome_completo }}</div>
                {% if j.posicao %}
                  <div class="text-xs text-slate-500">{{ j.posicao }}</div>
                {% endif %}
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="text-center py-8 text-sm text-slate-500">Nenhum jogador cadastrado</div>
      {% endif %}
    {% endcall %}

    {% call card("Escalação - " ~ (fora.nome or "Fora"), "Jogadores do time visitante", "users", "green") %}
      {% if fora.jogadores and fora.jogadores|length %}
        <div class="space-y-2">
          {% for j in fora.jogadores %}
            <div class="rounded-md bg-white/60 backdrop-blur-xl p-3 flex items-center gap-3">
              <div class="w-8 h-8 rounded-md bg-emerald-50/80 text-emerald-600 grid place-items-center text-xs font-semibold">
                {{ loop.index }}
              </div>
              <div class="flex-1">
                <div class="text-sm font-medium text-slate-900">{{ j.apelido or j.nome_completo }}</div>
                {% if j.posicao %}
                  <div class="text-xs text-slate-500">{{ j.posicao }}</div>
                {% endif %}
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="text-center py-8 text-sm text-slate-500">Nenhum jogador cadastrado</div>
      {% endif %}
    {% endcall %}
  </div>
</div>

<!-- Tab Content: H2H -->
<div id="content-h2h" class="tab-partida-content hidden">
  {% call card("Histórico de Confrontos", "Partidas anteriores entre os times", "git-compare", "orange") %}
    <div class="text-center py-12">
      <div class="mb-4 inline-flex items-center justify-center w-14 h-14 rounded-md bg-orange-50/80 text-orange-400">
        <i data-lucide="git-compare" class="w-6 h-6"></i>
      </div>
      <div class="text-sm text-slate-800 font-semibold">Histórico em breve</div>
      <div class="text-xs text-slate-500 mt-1.5">O histórico de confrontos estará disponível em breve.</div>
    </div>
  {% endcall %}
</div>

<script>
function showPartidaTab(tabName) {
  // Esconde todos os conteúdos
  document.querySelectorAll('.tab-partida-content').forEach(content => {
    content.classList.add('hidden');
  });
  
  // Remove active de todas as tabs
  document.querySelectorAll('.tab-partida-btn').forEach(btn => {
    btn.classList.remove('active', 'bg-emerald-500', 'text-white');
    btn.classList.add('bg-white/60', 'text-slate-600');
  });
  
  // Mostra o conteúdo selecionado
  const content = document.getElementById('content-' + tabName);
  if (content) {
    content.classList.remove('hidden');
  }
  
  // Ativa a tab selecionada
  const tab = document.getElementById('tab-' + tabName);
  if (tab) {
    tab.classList.add('active', 'bg-emerald-500', 'text-white');
    tab.classList.remove('bg-white/60', 'text-slate-600');
  }
  
  // Reinicializa ícones Lucide
  if (window.lucide) {
    window.lucide.createIcons();
  }
}

(function() {
  const allJogadores = {};
  const allAssistencias = {};
  
  function initFilter() {
    const timeSelect = document.getElementById('timeSelect');
    const jogadorSelect = document.getElementById('jogadorSelect');
    const assistenciaSelect = document.getElementById('assistenciaSelect');
    
    if (!timeSelect || !jogadorSelect || !assistenciaSelect) {
      setTimeout(initFilter, 500);
      return;
    }
    
    Array.from(jogadorSelect.options).forEach(opt => {
      if (!allJogadores[opt.value]) {
        allJogadores[opt.value] = {
          element: opt.cloneNode(true),
          time: opt.getAttribute('data-time')
        };
      }
    });
    
    Array.from(assistenciaSelect.options).forEach(opt => {
      if (!allAssistencias[opt.value]) {
        allAssistencias[opt.value] = {
          element: opt.cloneNode(true),
          time: opt.getAttribute('data-time')
        };
      }
    });
    
    function filterJogadores(selectElement, allOptions, selectedTime) {
      const selectedValue = selectElement.value;
      const firstOption = selectElement.options[0];
      const isFirstEmpty = firstOption && firstOption.value === '';
      
      selectElement.innerHTML = '';
      
      if (isFirstEmpty) {
        selectElement.appendChild(firstOption.cloneNode(true));
      }
      
      Object.keys(allOptions).forEach(value => {
        const optData = allOptions[value];
        if (optData.time === selectedTime) {
          selectElement.appendChild(optData.element.cloneNode(true));
        }
      });
      
      if (selectElement.dataset.ddInit) {
        const event = new Event('change', { bubbles: true });
        selectElement.dispatchEvent(event);
      }
      
      if (selectedValue && Array.from(selectElement.options).some(opt => opt.value === selectedValue)) {
        selectElement.value = selectedValue;
      } else {
        selectElement.value = '';
      }
    }
    
    function updateJogadores() {
      const selectedOption = timeSelect.options[timeSelect.selectedIndex];
      if (!selectedOption) return;
      
      const selectedTime = selectedOption.getAttribute('data-time');
      if (!selectedTime) return;
      
      filterJogadores(jogadorSelect, allJogadores, selectedTime);
      filterJogadores(assistenciaSelect, allAssistencias, selectedTime);
    }
    
    updateJogadores();
    timeSelect.addEventListener('change', updateJogadores);
    
    document.body.addEventListener('htmx:afterSwap', function(e) {
      if (e.target.querySelector('#timeSelect')) {
        setTimeout(initFilter, 100);
      }
    });
  }
  
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initFilter);
  } else {
    initFilter();
  }
})();
</script>

<style>
.scrollbar-hide {
  -ms-overflow-style: none;
  scrollbar-width: none;
}
.scrollbar-hide::-webkit-scrollbar {
  display: none;
}
</style>

{% endblock %}
