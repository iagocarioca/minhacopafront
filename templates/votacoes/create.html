{% extends "layout/base.html" %}
{% from "layout/card.html" import card %}
{% block breadcrumb %}Rodada • Votações{% endblock %}
{% block page_title %}Votações{% endblock %}
{% block content %}

{% call card("Criar votação", "Nova votação", "vote", "blue") %}
<form method="post" class="space-y-3" onsubmit="return buildVotacaoIso();">
  <div>
    <label class="block text-xs font-medium text-slate-700 mb-1.5">Tipo</label>
    <input name="tipo" placeholder="Ex: MVP" class="w-full text-sm px-4 py-2.5 rounded-md bg-white/60 backdrop-blur-xl text-slate-900 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-primary-500/30" />
  </div>

  <input type="hidden" id="abre_em" name="abre_em" />
  <input type="hidden" id="fecha_em" name="fecha_em" />

  <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
    <div>
      <label class="block text-xs font-medium text-slate-700 mb-1.5">Início</label>
      <div class="grid grid-cols-2 gap-2">
        <input id="abre_date" type="date" required class="w-full text-sm px-3 py-2.5 rounded-md bg-white/60 backdrop-blur-xl text-slate-900 focus:outline-none focus:ring-2 focus:ring-primary-500/30" />
        <input id="abre_time" type="time" required class="w-full text-sm px-3 py-2.5 rounded-md bg-white/60 backdrop-blur-xl text-slate-900 focus:outline-none focus:ring-2 focus:ring-primary-500/30" />
      </div>
    </div>
    <div>
      <label class="block text-xs font-medium text-slate-700 mb-1.5">Fim</label>
      <div class="grid grid-cols-2 gap-2">
        <input id="fecha_date" type="date" required class="w-full text-sm px-3 py-2.5 rounded-md bg-white/60 backdrop-blur-xl text-slate-900 focus:outline-none focus:ring-2 focus:ring-primary-500/30" />
        <input id="fecha_time" type="time" required class="w-full text-sm px-3 py-2.5 rounded-md bg-white/60 backdrop-blur-xl text-slate-900 focus:outline-none focus:ring-2 focus:ring-primary-500/30" />
      </div>
    </div>
  </div>

  <div class="grid grid-cols-3 gap-2">
    <button type="button" onclick="setAbrirAgora()" class="h-10 rounded-md bg-emerald-50/80 hover:bg-emerald-50 text-xs font-medium text-emerald-700 inline-flex items-center justify-center gap-1.5 transition-all">
      <i data-lucide="clock" class="w-3.5 h-3.5"></i>
      <span>Agora</span>
    </button>
    <button type="button" onclick="setFecharEm2h()" class="h-10 rounded-md bg-orange-50/80 hover:bg-orange-50 text-xs font-medium text-orange-700 inline-flex items-center justify-center gap-1.5 transition-all">
      <i data-lucide="timer" class="w-3.5 h-3.5"></i>
      <span>+2h</span>
    </button>
    <button type="button" onclick="setFecharAmanha()" class="h-10 rounded-md bg-blue-50/80 hover:bg-blue-50 text-xs font-medium text-blue-700 inline-flex items-center justify-center gap-1.5 transition-all">
      <i data-lucide="calendar" class="w-3.5 h-3.5"></i>
      <span>Amanhã</span>
    </button>
  </div>

  <div class="text-xs text-slate-600 bg-slate-50/60 rounded-md p-3">
    <div class="flex items-start gap-2">
      <i data-lucide="info" class="w-3.5 h-3.5 mt-0.5 text-slate-500"></i>
      <div class="flex-1 space-y-1.5">
        <div class="text-[11px] text-slate-600">Será enviado: <span id="preview_abre" class="text-emerald-600 font-medium">—</span></div>
        <div class="text-[11px] text-slate-600">até: <span id="preview_fecha" class="text-rose-600 font-medium">—</span></div>
        <label class="flex items-center gap-2 cursor-pointer pt-1.5">
          <input type="checkbox" id="use_utc" class="rounded border-slate-300 text-primary-600 focus:ring-primary-500/20" />
          <span class="text-[11px] text-slate-600">Converter para UTC</span>
        </label>
      </div>
    </div>
  </div>

  <button class="w-full h-11 rounded-md bg-gradient-to-r from-primary-500 to-primary-600 hover:from-primary-600 hover:to-primary-700 text-white text-sm font-medium transition-all inline-flex items-center justify-center gap-2">
    <i data-lucide="plus" class="w-4 h-4"></i>
    Criar
  </button>
</form>
{% endcall %}

{% if created_id %}
{% set created_path = "/votacoes/" ~ created_id ~ "/votar?rodada_id=" ~ rodada_id %}
{% call card("Votação Criada", "Link gerado", "check-circle", "green") %}
<div class="space-y-2">
  <div class="flex gap-2">
    <a href="{{ created_path }}" class="flex-1 h-10 rounded-md bg-emerald-50/80 hover:bg-emerald-50 text-xs font-medium text-emerald-700 inline-flex items-center justify-center gap-2 transition-all">
      <i data-lucide="check-square" class="w-3.5 h-3.5"></i>
      Votar
    </a>
    <a href="{{ url_for('votacoes.resultado', votacao_id=created_id, rodada_id=rodada_id) }}" class="flex-1 h-10 rounded-md bg-white/60 backdrop-blur-xl hover:bg-white/80 text-xs font-medium text-slate-700 inline-flex items-center justify-center gap-2 transition-all">
      <i data-lucide="trophy" class="w-3.5 h-3.5"></i>
      Resultado
    </a>
  </div>
  <div class="flex gap-2">
    <input id="created_link" readonly value="{{ request.url_root.rstrip('/') ~ created_path }}" class="flex-1 text-xs px-3 py-2 rounded-md bg-white/60 backdrop-blur-xl text-slate-900 font-mono" />
    <button type="button" onclick="copyCreatedLink()" class="h-10 px-3 rounded-md bg-white/60 backdrop-blur-xl hover:bg-white/80 text-xs font-medium text-slate-700 inline-flex items-center gap-2 transition-all">
      <i data-lucide="copy" class="w-3.5 h-3.5"></i>
    </button>
  </div>
</div>
{% endcall %}
{% endif %}

{% if recent_votacoes %}
{% call card("Votações recentes", "Últimas " ~ (recent_votacoes|length), "clock", "purple") %}
<div class="space-y-2">
  {% for v in recent_votacoes %}
  {% set p = "/votacoes/" ~ v.id ~ "/votar?rodada_id=" ~ v.rodada_id %}
  <div class="rounded-md bg-white/40 backdrop-blur-xl border border-slate-300/60 px-3 py-2.5 flex items-center justify-between gap-2">
    <div class="flex-1 min-w-0">
      <div class="text-sm font-medium text-slate-900">{{ v.tipo or "Votação" }}</div>
      {% if v.abre_em and v.fecha_em %}
      <div class="text-[11px] text-slate-500 mt-0.5">{{ v.abre_em | data_br(True) }} → {{ v.fecha_em | data_br(True) }}</div>
      {% endif %}
    </div>
    <div class="flex gap-1.5">
      <a href="{{ url_for('votacoes.resultado', votacao_id=v.id, rodada_id=v.rodada_id) }}" class="h-9 px-2.5 rounded-md bg-emerald-50/80 hover:bg-emerald-50 text-xs font-medium text-emerald-700 inline-flex items-center gap-1 transition-all" title="Resultado">
        <i data-lucide="trophy" class="w-3.5 h-3.5"></i>
      </a>
      <a href="{{ p }}" class="h-9 px-2.5 rounded-md bg-white/60 backdrop-blur-xl hover:bg-white/80 text-xs font-medium text-slate-700 inline-flex items-center gap-1 transition-all">
        <i data-lucide="check-square" class="w-3.5 h-3.5"></i>
      </a>
    </div>
  </div>
  {% endfor %}
</div>
{% endcall %}
{% endif %}

<script>
function buildApiDatetime(d, t, convertToUTC = false) {
  if (!convertToUTC) {
    return `${d} ${t}:00`;
  }
  const localDate = new Date(`${d}T${t}:00`);
  const year = localDate.getUTCFullYear();
  const month = String(localDate.getUTCMonth() + 1).padStart(2, '0');
  const day = String(localDate.getUTCDate()).padStart(2, '0');
  const hours = String(localDate.getUTCHours()).padStart(2, '0');
  const minutes = String(localDate.getUTCMinutes()).padStart(2, '0');
  return `${year}-${month}-${day} ${hours}:${minutes}:00`;
}

function updatePreview() {
  const abreDate = document.getElementById("abre_date")?.value;
  const abreTime = document.getElementById("abre_time")?.value;
  const fechaDate = document.getElementById("fecha_date")?.value;
  const fechaTime = document.getElementById("fecha_time")?.value;
  const useUTC = document.getElementById("use_utc")?.checked || false;
  if (!abreDate || !abreTime || !fechaDate || !fechaTime) {
    const pa = document.getElementById("preview_abre");
    const pf = document.getElementById("preview_fecha");
    if (pa) pa.textContent = "—";
    if (pf) pf.textContent = "—";
    return;
  }
  const abre = buildApiDatetime(abreDate, abreTime, useUTC);
  const fecha = buildApiDatetime(fechaDate, fechaTime, useUTC);
  const pa = document.getElementById("preview_abre");
  const pf = document.getElementById("preview_fecha");
  if (pa) pa.textContent = abre + (useUTC ? ' (UTC)' : '');
  if (pf) pf.textContent = fecha + (useUTC ? ' (UTC)' : '');
}

function buildVotacaoIso() {
  updatePreview();
  const abreDate = document.getElementById("abre_date")?.value;
  const abreTime = document.getElementById("abre_time")?.value;
  const fechaDate = document.getElementById("fecha_date")?.value;
  const fechaTime = document.getElementById("fecha_time")?.value;
  const useUTC = document.getElementById("use_utc")?.checked || false;
  if (!abreDate || !abreTime || !fechaDate || !fechaTime) {
    alert("Selecione data e horário de início e fim.");
    return false;
  }
  const abreTimestamp = new Date(`${abreDate}T${abreTime}`).getTime();
  const fechaTimestamp = new Date(`${fechaDate}T${fechaTime}`).getTime();
  if (fechaTimestamp <= abreTimestamp) {
    alert("A data/hora de FIM deve ser posterior à de INÍCIO.");
    return false;
  }
  const abre = buildApiDatetime(abreDate, abreTime, useUTC);
  const fecha = buildApiDatetime(fechaDate, fechaTime, useUTC);
  const hidA = document.getElementById("abre_em");
  const hidF = document.getElementById("fecha_em");
  if (hidA) hidA.value = abre;
  if (hidF) hidF.value = fecha;
  return true;
}

function copyCreatedLink() {
  const el = document.getElementById("created_link");
  if (!el) return;
  el.select();
  el.setSelectionRange(0, 99999);
  try {
    navigator.clipboard.writeText(el.value);
  } catch (e) {
    document.execCommand("copy");
  }
}

function formatDateForInput(date) {
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
}

function formatTimeForInput(date) {
  const hours = String(date.getHours()).padStart(2, '0');
  const minutes = String(date.getMinutes()).padStart(2, '0');
  return `${hours}:${minutes}`;
}

function setAbrirAgora() {
  const now = new Date();
  const date = formatDateForInput(now);
  const time = formatTimeForInput(now);
  const dateEl = document.getElementById("abre_date");
  const timeEl = document.getElementById("abre_time");
  if (dateEl) dateEl.value = date;
  if (timeEl) timeEl.value = time;
  updatePreview();
}

function setFecharEm2h() {
  const future = new Date();
  future.setHours(future.getHours() + 2);
  const date = formatDateForInput(future);
  const time = formatTimeForInput(future);
  const dateEl = document.getElementById("fecha_date");
  const timeEl = document.getElementById("fecha_time");
  if (dateEl) dateEl.value = date;
  if (timeEl) timeEl.value = time;
  updatePreview();
}

function setFecharAmanha() {
  const tomorrow = new Date();
  tomorrow.setDate(tomorrow.getDate() + 1);
  tomorrow.setHours(23, 59, 0, 0);
  const date = formatDateForInput(tomorrow);
  const time = formatTimeForInput(tomorrow);
  const dateEl = document.getElementById("fecha_date");
  const timeEl = document.getElementById("fecha_time");
  if (dateEl) dateEl.value = date;
  if (timeEl) timeEl.value = time;
  updatePreview();
}

document.addEventListener("DOMContentLoaded", () => {
  setTimeout(() => {
    setAbrirAgora();
    setFecharEm2h();
    ["abre_date","abre_time","fecha_date","fecha_time"].forEach((id) => {
      const el = document.getElementById(id);
      if (el) {
        el.addEventListener("change", updatePreview);
        el.addEventListener("input", updatePreview);
      }
    });
    const utcCheckbox = document.getElementById("use_utc");
    if (utcCheckbox) {
      utcCheckbox.addEventListener("change", updatePreview);
    }
    updatePreview();
  }, 100);
});
</script>
{% endblock %}
