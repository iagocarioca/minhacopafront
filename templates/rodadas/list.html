{% extends "layout/base.html" %}
{% from "layout/card.html" import card %}
{% block breadcrumb %}Temporada • Rodadas{% endblock %}
{% block page_title %}Rodadas{% endblock %}
{% block content %}

<!-- Header com stats -->
<div class="grid grid-cols-2 gap-4 mb-6">
  <div class="rounded-md bg-white/60 backdrop-blur-xl p-4">
    <div class="text-[10px] text-slate-500 mb-1 font-medium">Total de rodadas</div>
    <div class="text-2xl font-medium text-slate-900">{{ data.meta.total or 0 }}</div>
  </div>
  <div class="rounded-md bg-white/60 backdrop-blur-xl p-4">
    <div class="text-[10px] text-slate-500 mb-1 font-medium">Página</div>
    <div class="text-2xl font-medium text-slate-900">{{ data.meta.page }}/{{ data.meta.total_pages }}</div>
  </div>
</div>

<div class="grid lg:grid-cols-2 gap-4">
  <!-- Rodadas (no topo) -->
  {% call card("Rodadas", data.data|length ~ " rodadas cadastradas", "trophy", "purple") %}
    <div class="space-y-2">
      {% for r in data.data %}
        <a href="/rodadas/{{r.id}}" class="block rounded-lg bg-white/50 backdrop-blur-xl border border-slate-300/60 hover-border p-4 transition-all group">
          <div class="flex items-center justify-between gap-3">
            <div class="flex items-center gap-3 min-w-0">
              <div class="w-10 h-10 rounded-lg bg-emerald-50/80 border border-emerald-200/70 grid place-items-center text-emerald-700 flex-shrink-0">
                <i data-lucide="soccer-ball" class="w-5 h-5"></i>
              </div>
              <div class="min-w-0">
                <div class="flex items-center gap-2 flex-wrap">
                  <div class="text-sm font-semibold text-slate-900 truncate">{{ loop.index }}ª Rodada</div>
                  <span class="inline-flex items-center gap-1.5 px-2 py-0.5 rounded-full text-[11px] font-semibold
                    {% if r.status == 'finalizada' %}bg-slate-100/80 text-slate-700
                    {% elif r.status == 'em_andamento' %}bg-emerald-50/80 text-emerald-700
                    {% else %}bg-blue-50/80 text-blue-700{% endif %}">
                    <span class="w-1.5 h-1.5 rounded-full
                      {% if r.status == 'finalizada' %}bg-slate-400
                      {% elif r.status == 'em_andamento' %}bg-emerald-500
                      {% else %}bg-blue-500{% endif %}"></span>
                    {{ r.status }}
                  </span>
                </div>
                <div class="text-xs text-slate-600 mt-1 flex items-center gap-2 flex-wrap">
                  <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-slate-100/80 border border-slate-300/60 text-slate-600">
                    <i data-lucide="calendar" class="w-3 h-3"></i>
                    {{ r.data_rodada | data_br if r.data_rodada else "—" }}
                  </span>
                  <span class="text-slate-300">•</span>
                  <span class="inline-flex items-center gap-1 text-[11px] text-slate-500">
                    <i data-lucide="users" class="w-3.5 h-3.5"></i>
                    {{ r.quantidade_times }} times
                  </span>
                  <span class="text-slate-300">•</span>
                  <span class="inline-flex items-center gap-1 text-[11px] text-slate-500">
                    <i data-lucide="user" class="w-3.5 h-3.5"></i>
                    {{ r.jogadores_por_time }} / time
                  </span>
                </div>
              </div>
            </div>
            <i data-lucide="chevron-right" class="w-5 h-5 text-slate-300 group-hover:text-slate-600 transition-colors flex-shrink-0"></i>
          </div>
        </a>
      {% else %}
        <div class="text-center py-10">
          <div class="mb-3 inline-flex items-center justify-center w-12 h-12 rounded-lg bg-emerald-50/80 border border-emerald-200/70 text-emerald-700">
            <i data-lucide="soccer-ball" class="w-6 h-6"></i>
          </div>
          <div class="text-sm text-slate-800 font-semibold">Nenhuma rodada cadastrada</div>
          <div class="text-xs text-slate-600 mt-1">Crie sua primeira rodada.</div>
        </div>
      {% endfor %}
    </div>
  {% endcall %}

  <!-- Criar rodada (abaixo / ao lado) -->
  <div class="rounded-md bg-white/60 backdrop-blur-xl p-5">
    <button id="btnCriarRodada" onclick="toggleForm()" class="w-full h-11 rounded-md bg-white/60 backdrop-blur-xl border border-slate-300/60 hover:bg-white/80 text-sm font-semibold text-slate-700 transition-all inline-flex items-center justify-center gap-2">
      <i data-lucide="plus" class="w-4 h-4"></i>
      Criar nova rodada
    </button>

    <div id="formCriarRodada" class="hidden mt-4">
      <div class="mb-4">
        <div class="text-base font-medium text-slate-900">Nova Rodada</div>
        <div class="text-xs text-slate-500 mt-1">Selecione a data e os times</div>
      </div>

    {% if times_disponiveis and times_disponiveis|length >= 2 %}
    <form method="post" class="space-y-3">
      <div>
        <label class="block text-xs font-semibold text-slate-700 mb-1.5 inline-flex items-center gap-2">
          <i data-lucide="calendar" class="w-3.5 h-3.5"></i>
          Data da rodada
        </label>
        <input type="date" name="data_rodada" required class="w-full text-sm px-4 py-3 rounded-md bg-white/60 backdrop-blur-xl text-slate-900 focus:outline-none focus:ring-2 focus:ring-emerald-500/30 transition-all" />
      </div>

      <div>
        <label class="block text-xs font-semibold text-slate-700 mb-1.5 inline-flex items-center gap-2">
          <i data-lucide="shirt" class="w-3.5 h-3.5"></i>
          Times participantes
        </label>
        <div class="grid grid-cols-2 sm:grid-cols-3 gap-3 max-h-64 overflow-y-auto p-2 rounded-md bg-white/40 backdrop-blur-xl" id="times-container">
          {% for t in times_disponiveis %}
            <div 
              class="time-select-item rounded-md bg-white/60 backdrop-blur-xl p-4 cursor-pointer transition-all border-2 border-transparent hover:border-emerald-300/50 hover:bg-white/80"
              data-time-id="{{t.id}}"
              onclick="toggleTimeSelection(this, {{t.id}})"
            >
              <div class="flex items-center justify-between mb-2">
                <div class="w-5 h-5 rounded-md border-2 border-slate-300 flex items-center justify-center transition-all time-checkbox">
                  <i data-lucide="check" class="w-3 h-3 text-white hidden time-check-icon"></i>
                </div>
                {% if t.cor %}
                  <span class="text-[10px] px-2 py-0.5 rounded-full bg-slate-100/80 text-slate-600 font-medium">{{ t.cor }}</span>
                {% endif %}
              </div>
              <div class="text-sm font-semibold text-slate-900 truncate">{{ t.nome }}</div>
              <input type="checkbox" name="time_ids" value="{{t.id}}" class="hidden time-input" />
            </div>
          {% endfor %}
        </div>
      </div>

      <div class="grid grid-cols-2 gap-3">
        <div>
          <label class="block text-xs font-semibold text-slate-700 mb-1.5 inline-flex items-center gap-2">
            <i data-lucide="users" class="w-3.5 h-3.5"></i>
            Qtd. de times
          </label>
          <input type="number" name="quantidade_times" min="2" max="20" placeholder="Ex: 4" required class="w-full text-sm px-4 py-3 rounded-md bg-white/60 backdrop-blur-xl text-slate-900 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-emerald-500/30 transition-all" />
        </div>
        <div>
          <label class="block text-xs font-semibold text-slate-700 mb-1.5 inline-flex items-center gap-2">
            <i data-lucide="user" class="w-3.5 h-3.5"></i>
            Jogadores/time
          </label>
          <input type="number" name="jogadores_por_time" min="3" max="11" placeholder="Ex: 5" required class="w-full text-sm px-4 py-3 rounded-md bg-white/60 backdrop-blur-xl text-slate-900 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-emerald-500/30 transition-all" />
        </div>
      </div>

      <div class="text-xs text-slate-600 bg-emerald-50/60 backdrop-blur-xl rounded-md p-4 flex items-start gap-3 border border-emerald-200/60">
        <i data-lucide="info" class="w-4 h-4 mt-0.5 text-emerald-700"></i>
        <span>Dica: monte a rodada como um “jogo” — depois crie os confrontos e registre os gols.</span>
      </div>

      <div class="flex gap-2">
        <button type="submit" class="flex-1 h-11 rounded-md bg-emerald-600 hover:bg-emerald-700 text-white text-sm font-semibold transition-all inline-flex items-center justify-center gap-2">
          <i data-lucide="check" class="w-4 h-4"></i>
          Criar
        </button>
        <button type="button" onclick="toggleForm()" class="h-11 px-4 rounded-md bg-white/70 backdrop-blur-xl hover:bg-white text-slate-700 font-semibold text-sm transition-all inline-flex items-center justify-center border border-slate-300/60">
          Cancelar
        </button>
      </div>
    </form>
    {% else %}
      <div class="text-center py-8">
        <div class="mb-3 inline-flex items-center justify-center w-11 h-11 rounded bg-slate-50/70 border border-slate-300/60 text-slate-500">
          <i data-lucide="shirt" class="w-5 h-5"></i>
        </div>
        <div class="text-sm text-slate-800 font-semibold">Você precisa criar times primeiro.</div>
        <div class="text-xs text-slate-600 mt-1 mb-4">Crie pelo menos 2 times na pelada antes de criar uma rodada.</div>
        <div class="flex gap-2 justify-center">
          <a href="/temporadas/{{temporada_id}}/times" class="inline-flex items-center justify-center gap-2 h-11 px-4 rounded-md bg-white/40 backdrop-blur-xl border border-slate-300/60 hover-border text-sm font-medium text-slate-700 transition-all">
            <i data-lucide="plus" class="w-4 h-4"></i>
            Criar times
          </a>
          <button type="button" onclick="toggleForm()" class="px-4 h-11 rounded-md bg-slate-100 hover:bg-slate-200 text-slate-700 font-medium text-sm transition-all inline-flex items-center justify-center">
            Cancelar
          </button>
        </div>
      </div>
    {% endif %}
    </div>
  </div>

</div>

<script>
function toggleForm() {
  const form = document.getElementById('formCriarRodada');
  const btn = document.getElementById('btnCriarRodada');
  
  if (form.classList.contains('hidden')) {
    form.classList.remove('hidden');
    btn.classList.add('hidden');
    // Inicializar ícones do Lucide após mostrar o formulário
    if (typeof lucide !== 'undefined') {
      lucide.createIcons();
    }
  } else {
    form.classList.add('hidden');
    btn.classList.remove('hidden');
  }
}

function toggleTimeSelection(element, timeId) {
  const checkbox = element.querySelector('.time-input');
  const checkIcon = element.querySelector('.time-check-icon');
  const checkBox = element.querySelector('.time-checkbox');
  
  if (!checkbox) return;
  
  // Toggle checkbox
  checkbox.checked = !checkbox.checked;
  
  // Update visual state
  if (checkbox.checked) {
    element.classList.add('selected');
    element.classList.remove('border-transparent', 'bg-white/60');
    element.classList.add('border-emerald-500', 'bg-emerald-50/80');
    checkBox.classList.remove('border-slate-300');
    checkBox.classList.add('bg-emerald-500', 'border-emerald-500');
    if (checkIcon) checkIcon.classList.remove('hidden');
  } else {
    element.classList.remove('selected');
    element.classList.remove('border-emerald-500', 'bg-emerald-50/80');
    element.classList.add('border-transparent', 'bg-white/60');
    checkBox.classList.remove('bg-emerald-500', 'border-emerald-500');
    checkBox.classList.add('border-slate-300');
    if (checkIcon) checkIcon.classList.add('hidden');
  }
  
  // Reinicializa ícones Lucide
  if (window.lucide) {
    window.lucide.createIcons();
  }
}

// Inicializar estado dos times já selecionados (se houver)
document.addEventListener('DOMContentLoaded', () => {
  const container = document.getElementById('times-container');
  if (!container) return;
  
  const items = container.querySelectorAll('.time-select-item');
  items.forEach(item => {
    const checkbox = item.querySelector('.time-input');
    if (checkbox && checkbox.checked) {
      toggleTimeSelection(item, checkbox.value);
    }
  });
  
  // Inicializar ícones Lucide
  if (window.lucide) {
    window.lucide.createIcons();
  }
});
</script>

<style>
.time-select-item {
  min-height: 80px;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
}

.time-select-item.selected {
  border-color: rgb(16, 185, 129) !important;
  background: rgba(236, 253, 245, 0.8) !important;
}

.time-checkbox {
  transition: all 0.2s ease;
}

.time-select-item.selected .time-checkbox {
  background-color: rgb(16, 185, 129) !important;
  border-color: rgb(16, 185, 129) !important;
}
</style>

{% endblock %}
